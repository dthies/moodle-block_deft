define("block_deft/refresh",["exports","core/fragment","core/log","block_deft/socket","core/templates"],(function(_exports,_fragment,_log,_socket,_templates){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_fragment=_interopRequireDefault(_fragment),_log=_interopRequireDefault(_log),_socket=_interopRequireDefault(_socket),_templates=_interopRequireDefault(_templates);var _default=function(){function _default(contextid,selector,token,throttle){var _this=this;(function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,_default),token)&&(this.contextid=contextid,this.selector=selector,this.throttle=throttle,this.throttled=!1,this.lastupdate=0,new _socket.default(contextid,token).subscribe((function(){_this.update()})))}var Constructor,protoProps,staticProps;return Constructor=_default,(protoProps=[{key:"update",value:function(){var _this2=this,content=document.querySelector(this.selector).parentNode,component=content.closest("[data-component]")&&content.closest("[data-component]").getAttribute("data-component")||"block_deft",data={};content&&(this.lastupdate+this.throttle>Date.now()||document.activeElement.closest(this.selector)&&document.activeElement.closest("select")?(!this.throttled||this.lastupdate+this.throttle<Date.now())&&(setTimeout((function(){_this2.update()}),Math.max(this.lastupdate+this.throttle-Date.now(),40)),this.throttled=!0):(document.querySelector(this.selector).querySelectorAll('[data-type="comments"] .block_deft_comments.expanded').forEach((function(opencomments){data.opencomments=data.opencomments||[],data.opencomments.push(opencomments.closest("[data-task]").getAttribute("data-task"))})),document.querySelector(this.selector).closest("[data-modified]")&&(data.lastmodified=document.querySelector(this.selector).closest("[data-modified]").getAttribute("data-modified")),_fragment.default.loadFragment(component,"content",this.contextid,{jsondata:JSON.stringify(data)}).done((function(html,js){html&&_this2.replace(content,html,js)})).catch(_log.default.debug),this.throttled=!1,this.lastupdate=Date.now()))}},{key:"replace",value:function(content,html,js){var setScroll=function(){return!0},setHeight=function(){return!0};content.style.height=content.offsetHeight,setTimeout((function(){content.style.height=null})),content.querySelectorAll(".block_deft_comments").forEach((function(comments){var position=comments.scrollTop,task=comments.closest("[data-task]").getAttribute("data-task"),recurse=setScroll;_log.default.debug(position),setScroll=function(){content.querySelectorAll('[data-task="'+task+'"]').forEach((function(task){task.querySelector(".block_deft_comments").scrollTop=position,_log.default.debug(task.querySelector(".block_deft_comments")),_log.default.debug(position)})),recurse()}})),content.querySelectorAll("[data-summary]").forEach((function(summary){var height=summary.offsetHeight,task=summary.getAttribute("data-summary"),recurse=setHeight;setHeight=function(){content.querySelectorAll('[data-summary="'+task+'"]').forEach((function(summary){summary.setAttribute("style","min-height: "+height+"px;")})),recurse()}})),_templates.default.replaceNodeContents(content,html,js),setScroll(),setHeight()}}])&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),_default}();return _exports.default=_default,_exports.default}));

//# sourceMappingURL=refresh.min.js.map