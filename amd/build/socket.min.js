define("block_deft/socket",["exports","core/ajax","core/log","core/notification"],(function(_exports,_ajax,_log,_notification){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/*
   * Open and maintain a WebSocket to recieve messages from server.
   *
   * @package    block_deft
   * @module     block_deft/socket
   * @copyright  2022 Daniel Thies <dethies@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_ajax=_interopRequireDefault(_ajax),_log=_interopRequireDefault(_log),_notification=_interopRequireDefault(_notification);var _default=class{constructor(contextid,token){this.listeners=[],this.connect(contextid,token)}connect(contextid,token){return this.websocket=new WebSocket("wss://deftly.us/ws"),this.websocket.onopen=e=>{this.websocket.send(token),this.listeners.forEach((callback=>{this.websocket.addEventListener("message",callback),callback(e)}))},this.websocket.addEventListener("close",(e=>(_log.default.debug("Disconnected"),this.disconnected?this:(1011==e.code?(_log.default.debug("Authentication failed"),_ajax.default.call([{methodname:"block_deft_renew_token",args:{contextid:contextid},done:replacement=>{_log.default.debug("Reconnecting"),this.connect(contextid,replacement.token)},fail:_notification.default.exception}])):setTimeout((()=>{_log.default.debug("Reconnecting"),this.connect(contextid,token)}),5e3),!0)))),this}disconnect(){return this.disconnected=!0,this.websocket.close(),this}subscribe(callback){return this.websocket.addEventListener("message",callback),this.listeners.push(callback),this}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=socket.min.js.map