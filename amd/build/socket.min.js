define("block_deft/socket",["exports","core/ajax","core/log","core/notification"],(function(_exports,_ajax,_log,_notification){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_ajax=_interopRequireDefault(_ajax),_log=_interopRequireDefault(_log),_notification=_interopRequireDefault(_notification);var _default=function(){function Socket(contextid,token){!function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,Socket),this.listeners=[],this.connect(contextid,token)}var Constructor,protoProps,staticProps;return Constructor=Socket,(protoProps=[{key:"connect",value:function(contextid,token){var _this=this;return this.websocket=new WebSocket("wss://deftly.us/ws"),this.websocket.onopen=function(e){_this.websocket.send(token),_this.listeners.forEach((function(callback){_this.websocket.addEventListener("message",callback),callback(e)}))},this.websocket.addEventListener("close",(function(e){return _log.default.debug("Disconnected"),_this.disconnected?_this:(1011==e.code?(_log.default.debug("Authentication failed"),_ajax.default.call([{methodname:"block_deft_renew_token",args:{contextid:contextid},done:function(replacement){_log.default.debug("Reconnecting"),_this.connect(contextid,replacement.token)},fail:_notification.default.exception}])):setTimeout((function(){_log.default.debug("Reconnecting"),_this.connect(contextid,token)}),5e3),!0)})),this}},{key:"disconnect",value:function(){return this.disconnected=!0,this.websocket.close(),this}},{key:"subscribe",value:function(callback){return this.websocket.addEventListener("message",callback),this.listeners.push(callback),this}}])&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Socket}();return _exports.default=_default,_exports.default}));

//# sourceMappingURL=socket.min.js.map