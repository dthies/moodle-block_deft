{"version":3,"file":"manage.min.js","sources":["../src/manage.js"],"sourcesContent":["/*\n * Manage task user interface handlers\n *\n * @package    block_deft\n * @module     block_deft/manage\n * @copyright  2022 Daniel Thies <dethies@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport ModalForm from 'core_form/modalform';\nimport Templates from 'core/templates';\nimport Log from 'core/log';\nimport {get_string as getString} from 'core/str';\n\nvar contextid;\n\n/**\n * Submit data for processing\n *\n * @param {Event} e Event object\n */\nconst submitForm = (e) => {\n    'use strict';\n\n    Log.debug('Form submitted');\n    if (e.detail && e.detail.order) {\n        e.detail.order.forEach((task) => {\n            document.querySelector('.tasks > div').appendChild(\n                document.querySelector('.tasks [data-id=\"' + task + '\"]').parentNode\n            );\n        });\n        return;\n    }\n    if (e.detail && e.detail.id) {\n        if (document.querySelector('[data-id=\"' + e.detail.id + '\"] [data-region=\"taskinfo\"]')) {\n            if (e.detail.html) {\n                Templates.replaceNodeContents(\n                    document.querySelector('[data-id=\"' + e.detail.id + '\"] [data-region=\"taskinfo\"]'),\n                    e.detail.html,\n                    ''\n                );\n            } else {\n                document.querySelector('.tasks [data-id=\"' + e.detail.id + '\"]').parentNode.remove(true);\n            }\n\n            return;\n        }\n        Templates.render('block_deft/task', e.detail).done((html, js) => {\n            const node = document.createElement('div');\n            node.innerHTML = html;\n            document.querySelector('.tasks > div').appendChild(node.firstChild);\n            Templates.runTemplateJS(js);\n        });\n    }\n};\n\n/**\n * Handle submission actions\n *\n * @param {Event} e Event object\n */\nconst handleSubmit = (e) => {\n    'use strict';\n\n    if (e.target.matches('form') && !e.target.closest('[data-region=\"status\"]')) {\n        let formdata = new FormData(e.target),\n            component = e.target.closest('[data-component]')\n                && e.target.closest('[data-component]').getAttribute('data-component')\n                || 'block_deft',\n            id = formdata.get('id') || 0,\n            type = formdata.get('type') || e.submitter.value,\n            title,\n            action = e.submitter.name === 'action' && e.submitter.value;\n        e.preventDefault();\n        e.stopPropagation();\n        if (action === 'delete' || action === 'move') {\n            type = action;\n        }\n        switch (action) {\n            case 'delete':\n                title = getString('confirm', 'core');\n                break;\n            case 'move':\n                title = getString('move', 'core');\n                break;\n            case 'saveall':\n                document.querySelectorAll('[data-region=\"status\"] form.modified input[type=\"submit\"]').forEach((form) => {\n                    form.click();\n                });\n                return;\n            case 'status':\n                title = getString('changestatus', 'block_deft');\n                break;\n            default:\n                title = getString('edit' + type, 'block_deft');\n                break;\n        }\n        Log.debug('Create ' + type);\n        let modalForm = new ModalForm({\n            formClass: component + \"\\\\form\\\\\" + (action === 'status' ? \"status_\" : \"edit_\") + type,\n            args: {\n                contextid: contextid,\n                id: id\n            },\n            modalConfig: {\n                title: title\n            }\n        });\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, submitForm);\n        modalForm.show();\n    }\n};\n\n/**\n * Handle form change\n *\n * @param {Event} e Event object\n */\nconst handleChange = (e) => {\n    'use strict';\n\n    let form = e.target.closest('[data-region=\"status\"] form');\n    if (form) {\n        const data = new FormData(form),\n            params = new URLSearchParams(data);\n        if (form.getAttribute('data-value') === params.toString()) {\n           form.classList.remove('modified');\n        } else {\n           form.classList.add('modified');\n        }\n    }\n};\n\n/**\n * Initialize listeners\n *\n * @param {int} id Context id of block\n */\nexport const init = (id) => {\n    'use strict';\n\n    contextid = id;\n\n    document.removeEventListener('submit', handleSubmit);\n    document.addEventListener('submit', handleSubmit);\n\n    document.removeEventListener('change', handleChange);\n    document.addEventListener('change', handleChange);\n};\n"],"names":["contextid","submitForm","e","debug","detail","order","forEach","task","document","querySelector","appendChild","parentNode","id","html","replaceNodeContents","remove","render","done","js","node","createElement","innerHTML","firstChild","runTemplateJS","handleSubmit","target","matches","closest","title","formdata","FormData","component","getAttribute","get","type","submitter","value","action","name","preventDefault","stopPropagation","querySelectorAll","form","click","modalForm","ModalForm","formClass","args","modalConfig","addEventListener","events","FORM_SUBMITTED","show","handleChange","data","params","URLSearchParams","toString","classList","add","removeEventListener"],"mappings":";;;;;;;;SAcIA,2NAOEC,WAAcC,oBAGZC,MAAM,kBACND,EAAEE,QAAUF,EAAEE,OAAOC,MACrBH,EAAEE,OAAOC,MAAMC,SAASC,OACpBC,SAASC,cAAc,gBAAgBC,YACnCF,SAASC,cAAc,oBAAsBF,KAAO,MAAMI,uBAKlET,EAAEE,QAAUF,EAAEE,OAAOQ,GAAI,IACrBJ,SAASC,cAAc,aAAeP,EAAEE,OAAOQ,GAAK,2CAChDV,EAAEE,OAAOS,wBACCC,oBACNN,SAASC,cAAc,aAAeP,EAAEE,OAAOQ,GAAK,+BACpDV,EAAEE,OAAOS,KACT,IAGJL,SAASC,cAAc,oBAAsBP,EAAEE,OAAOQ,GAAK,MAAMD,WAAWI,QAAO,uBAKjFC,OAAO,kBAAmBd,EAAEE,QAAQa,MAAK,CAACJ,KAAMK,YAChDC,KAAOX,SAASY,cAAc,OACpCD,KAAKE,UAAYR,KACjBL,SAASC,cAAc,gBAAgBC,YAAYS,KAAKG,+BAC9CC,cAAcL,SAU9BM,aAAgBtB,OAGdA,EAAEuB,OAAOC,QAAQ,UAAYxB,EAAEuB,OAAOE,QAAQ,0BAA2B,KAOrEC,MANAC,SAAW,IAAIC,SAAS5B,EAAEuB,QAC1BM,UAAY7B,EAAEuB,OAAOE,QAAQ,qBACtBzB,EAAEuB,OAAOE,QAAQ,oBAAoBK,aAAa,mBAClD,aACPpB,GAAKiB,SAASI,IAAI,OAAS,EAC3BC,KAAOL,SAASI,IAAI,SAAW/B,EAAEiC,UAAUC,MAE3CC,OAA8B,WAArBnC,EAAEiC,UAAUG,MAAqBpC,EAAEiC,UAAUC,aAC1DlC,EAAEqC,iBACFrC,EAAEsC,kBACa,WAAXH,QAAkC,SAAXA,SACvBH,KAAOG,QAEHA,YACC,SACDT,OAAQ,mBAAU,UAAW,kBAE5B,OACDA,OAAQ,mBAAU,OAAQ,kBAEzB,sBACDpB,SAASiC,iBAAiB,6DAA6DnC,SAASoC,OAC5FA,KAAKC,eAGR,SACDf,OAAQ,mBAAU,eAAgB,4BAGlCA,OAAQ,mBAAU,OAASM,KAAM,2BAGrC/B,MAAM,UAAY+B,UAClBU,UAAY,IAAIC,mBAAU,CAC1BC,UAAWf,UAAY,YAAyB,WAAXM,OAAsB,UAAY,SAAWH,KAClFa,KAAM,CACF/C,UAAWA,UACXY,GAAIA,IAERoC,YAAa,CACTpB,MAAOA,SAGfgB,UAAUK,iBAAiBL,UAAUM,OAAOC,eAAgBlD,YAC5D2C,UAAUQ,SASZC,aAAgBnD,QAGdwC,KAAOxC,EAAEuB,OAAOE,QAAQ,kCACxBe,KAAM,OACAY,KAAO,IAAIxB,SAASY,MACtBa,OAAS,IAAIC,gBAAgBF,MAC7BZ,KAAKV,aAAa,gBAAkBuB,OAAOE,WAC5Cf,KAAKgB,UAAU3C,OAAO,YAEtB2B,KAAKgB,UAAUC,IAAI,4BAUT/C,KAGjBZ,UAAYY,GAEZJ,SAASoD,oBAAoB,SAAUpC,cACvChB,SAASyC,iBAAiB,SAAUzB,cAEpChB,SAASoD,oBAAoB,SAAUP,cACvC7C,SAASyC,iBAAiB,SAAUI"}