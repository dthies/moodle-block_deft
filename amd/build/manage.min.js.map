{"version":3,"file":"manage.min.js","sources":["../src/manage.js"],"sourcesContent":["/*\n * Manage task user interface handlers\n *\n * @package    block_deft\n * @module     block_deft/manage\n * @copyright  2022 Daniel Thies <dethies@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport ModalForm from 'core_form/modalform';\nimport Templates from 'core/templates';\nimport Log from 'core/log';\nimport {get_string as getString} from 'core/str';\n\nvar contextid;\n\n/**\n * Submit data for processing\n *\n * @param {Event} e Event object\n */\nconst submitForm = (e) => {\n    'use strict';\n\n    Log.debug('Form submitted');\n    if (e.detail && e.detail.order) {\n        e.detail.order.forEach((task) => {\n            document.querySelector('.tasks > div').appendChild(\n                document.querySelector('.tasks [data-id=\"' + task + '\"]').parentNode\n            );\n        });\n        return;\n    }\n    if (e.detail && e.detail.id) {\n        if (document.querySelector('[data-id=\"' + e.detail.id + '\"] [data-region=\"taskinfo\"]')) {\n            if (e.detail.html) {\n                Templates.replaceNodeContents(\n                    document.querySelector('[data-id=\"' + e.detail.id + '\"] [data-region=\"taskinfo\"]'),\n                    e.detail.html,\n                    ''\n                );\n            } else {\n                document.querySelector('.tasks [data-id=\"' + e.detail.id + '\"]').parentNode.remove(true);\n            }\n\n            return;\n        }\n        Templates.render('block_deft/task', e.detail).done((html, js) => {\n            const node = document.createElement('div');\n            node.innerHTML = html;\n            document.querySelector('.tasks > div').appendChild(node.firstChild);\n            Templates.runTemplateJS(js);\n        });\n    }\n};\n\n/**\n * Handle submission actions\n *\n * @param {Event} e Event object\n */\nconst handleSubmit = (e) => {\n    'use strict';\n\n    if (e.target.matches('form') && !e.target.closest('[data-region=\"status\"]')) {\n        let formdata = new FormData(e.target),\n            component = e.target.closest('[data-component]')\n                && e.target.closest('[data-component]').getAttribute('data-component')\n                || 'block_deft',\n            id = formdata.get('id') || 0,\n            type = formdata.get('type') || e.submitter.value,\n            title,\n            action = e.submitter.name === 'action' && e.submitter.value;\n        e.preventDefault();\n        e.stopPropagation();\n        if (action === 'delete' || action === 'move') {\n            type = action;\n        }\n        switch (action) {\n            case 'delete':\n                title = getString('confirm', 'core');\n                break;\n            case 'move':\n                title = getString('move', 'core');\n                break;\n            case 'saveall':\n                document.querySelectorAll('[data-region=\"status\"] form.modified input[type=\"submit\"]').forEach((form) => {\n                    form.click();\n                });\n                return;\n            case 'status':\n                title = getString('changestatus', 'block_deft');\n                break;\n            default:\n                title = getString('edit' + type, 'block_deft');\n                break;\n        }\n        Log.debug('Create ' + type);\n        let modalForm = new ModalForm({\n            formClass: component + \"\\\\form\\\\\" + (action === 'status' ? \"status_\" : \"edit_\") + type,\n            args: {\n                contextid: contextid,\n                id: id\n            },\n            modalConfig: {\n                title: title\n            }\n        });\n        modalForm.addEventListener(modalForm.events.FORM_SUBMITTED, submitForm);\n        modalForm.show();\n    }\n};\n\n/**\n * Handle form change\n *\n * @param {Event} e Event object\n */\nconst handleChange = (e) => {\n    'use strict';\n\n    let form = e.target.closest('[data-region=\"status\"] form');\n    if (form) {\n        const data = new FormData(form),\n            params = new URLSearchParams(data);\n        if (form.getAttribute('data-value') === params.toString()) {\n           form.classList.remove('modified');\n        } else {\n           form.classList.add('modified');\n        }\n    }\n};\n\n/**\n * Initialize listeners\n *\n * @param {int} id Context id of block\n */\nexport const init = (id) => {\n    'use strict';\n\n    contextid = id;\n\n    document.removeEventListener('submit', handleSubmit);\n    document.addEventListener('submit', handleSubmit);\n\n    document.removeEventListener('change', handleChange);\n    document.addEventListener('change', handleChange);\n};\n"],"names":["_interopRequireDefault","obj","__esModule","default","contextid","_modalform","_templates","_log","submitForm","e","Log","debug","detail","order","forEach","task","document","querySelector","appendChild","parentNode","id","html","Templates","replaceNodeContents","remove","render","done","js","node","createElement","innerHTML","firstChild","runTemplateJS","handleSubmit","target","matches","closest","title","formdata","FormData","component","getAttribute","get","type","submitter","value","action","name","preventDefault","stopPropagation","getString","querySelectorAll","form","click","get_string","modalForm","ModalForm","formClass","args","modalConfig","addEventListener","events","FORM_SUBMITTED","show","handleChange","data","params","URLSearchParams","toString","classList","add","_exports","init","removeEventListener"],"mappings":"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"}