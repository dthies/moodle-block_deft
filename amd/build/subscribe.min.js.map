{"version":3,"file":"subscribe.min.js","sources":["../src/subscribe.js"],"sourcesContent":["/**\n * Manage venue connections\n *\n * @module     block_deft/venue_manager\n * @copyright  2022 Daniel Thies <dethies@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from \"core/ajax\";\nimport Janus from 'block_deft/janus-gateway';\nimport Publish from 'block_deft/publish';\nimport Log from \"core/log\";\nimport Notification from \"core/notification\";\n\nexport default class Subscribe extends Publish {\n\n    /**\n     * Start to establish the peer connections\n     *\n     * @param {int} feed Initial feed\n     */\n    startConnection(feed) {\n        this.feed = feed;\n        this.current = feed;\n        this.transactions = {};\n\n        this.creatingSubscription = true;\n\n        this.remoteStreams = {};\n\n        // Initialize the library (all console debuggers enabled)\n        Janus.init({\n            debug: \"all\", callback: () => {\n                // Create session.\n                this.janus = new Janus(\n                    {\n                        server: this.server,\n                        iceServers: this.iceServers,\n                        success: () => {\n                            // Attach to video room test plugin\n                            this.janus.attach(\n                                {\n                                    plugin: \"janus.plugin.videoroom\",\n                                    opaqueId: \"videoroom-\" + Janus.randomString(12),\n                                    success: pluginHandle => {\n                                        this.videoroom = pluginHandle;\n                                        this.register(pluginHandle);\n                                    },\n                                    error: (error) => {\n                                        this.restart = true;\n                                        Janus.error(\"  -- Error attaching plugin...\", error);\n                                        Notification.alert('', \"Error attaching plugin... \" + error);\n                                    },\n                                    ondata: (data) => {\n                                        const message = JSON.parse(data);\n                                        if (message && message.feed) {\n                                            const publish = {\n                                                request: 'update',\n                                                subscribe: [{\n                                                    feed: message.feed,\n                                                    mid: message.mid,\n                                                }]\n                                            };\n                                            this.videoroom.send({\n                                                message: publish\n                                            });\n                                        }\n                                    },\n                                    onlocaltrack: this.onLocalTrack.bind(this),\n                                    onmessage: this.onMessage.bind(this),\n                                    onremotetrack: (track, mid, on, metadata) => {\n                                        Janus.debug(\n                                            \"Remote track (mid=\" + mid + \") \" +\n                                            (on ? \"added\" : \"removed\") +\n                                            (metadata ? \" (\" + metadata.reason + \") \" : \"\") + \":\", track\n                                        );\n                                        if (!on) {\n                                            // Track removed, get rid of the stream and the rendering\n                                          delete this.remoteStreams[mid];\n                                            return;\n                                        }\n                                        if (!this.remoteStreams.hasOwnProperty(mid) && track.kind === \"video\") {\n                                            this.remoteStreams[mid] = track;\n                                            if (this.remoteStream) {\n                                                return;\n                                            }\n                                            this.remoteStream = new MediaStream([track]);\n                                            this.remoteStream.mid = mid;\n                                            Log.debug(this.remoteStream);\n                                            this.attachVideo(this.remoteStream);\n                                        } else if (!this.remoteStreams.hasOwnProperty(mid) && track.kind === \"audio\") {\n                                            this.remoteStreams[mid] = track;\n                                            if (this.remoteAudioStream) {\n                                                return;\n                                            }\n                                            this.remoteAudioStream = new MediaStream([track]);\n                                            this.remoteAudioStream.mid = mid;\n                                            Log.debug(this.remoteAudioStream);\n                                            this.attachAudio(this.remoteAudioStream);\n                                        }\n                                    }\n                                }\n                            );\n                        },\n                        error: function(error) {\n                            this.restart = true;\n                            Log.debug(error);\n                        }\n                    }\n                );\n            }\n        });\n    }\n\n    /**\n     * Register the room\n     *\n     * @param {object} pluginHandle\n     * @return {Promise}\n     */\n    register(pluginHandle) {\n        return Ajax.call([{\n            args: {\n                handle: pluginHandle.getId(),\n                id: Number(this.peerid),\n                plugin: pluginHandle.plugin,\n                room: this.roomid,\n                ptype: false,\n                feed: this.feed,\n                session: pluginHandle.session.getSessionId()\n            },\n            contextid: this.contextid,\n            fail: Notification.exception,\n            methodname: 'block_deft_join_room'\n        }])[0];\n    }\n\n    onLocalTrack() {\n        return;\n    }\n\n    onMessage(msg, jsep) {\n        Log.debug(msg);\n                    const pluginHandle = this.videoroom;\n        Janus.debug(\" ::: Got a message :::\", msg);\n        const event = msg.videoroom;\n        Janus.debug(\"Event: \" + event);\n        switch (event) {\n            case 'joined':\n                // Successfully joined, negotiate WebRTC now\n                if (msg.id) {\n                    this.peerid = msg.id;\n                    Janus.log(\"Successfully joined room \" + msg.room + \" with ID \" + this.peerid);\n                    if (!this.webrtcUp) {\n                        const tracks = [{\n                            type: 'video',\n                            capture: true,\n                            recv: false\n                        }];\n                        this.webrtcUp = true;\n                        pluginHandle.createOffer({\n                            // We only want bidirectional audio\n                            tracks: tracks,\n                            success: (jsep) => {\n                                Janus.debug(\"Got SDP!\", jsep);\n                                const publish = {\n                                    request: \"configure\",\n                                    video: true,\n                                    audio: false\n                                };\n                                pluginHandle.send({\n                                    message: publish,\n                                    jsep: jsep\n                                });\n                            },\n                            error: function(error) {\n                                Janus.error(\"WebRTC error:\", error);\n                                Notification.alert(\"WebRTC error... \", error.message);\n                            }\n                        });\n                    }\n                }\n                break;\n            case 'destroyed':\n                // The room has been destroyed\n                Janus.warn(\"The room has been destroyed!\");\n                Notification.alert('', \"The room has been destroyed\", function() {\n                    window.close();\n                });\n                break;\n            case 'attached':\n                this.creatingSubscription = false;\n                break;\n            case 'event':\n                if (msg.error) {\n                    if (msg.error_code === 485) {\n                        // This is a \"no such room\" error: give a more meaningful description\n                        Notification.alert(\n                            \"<p>Apparently room <code>\" + this.roomid + \"</code> is not configured</p>\"\n                        );\n                    } else if (msg.error_code === 428) {\n                        this.restart = true;\n                    } else {\n                        Notification.alert(msg.error_code, msg.error);\n                    }\n                    return;\n                }\n                break;\n        }\n        if (jsep) {\n            Janus.debug(\"Handling SDP as well...\", jsep);\n            // Answer and attach\n            pluginHandle.createAnswer(\n                {\n                    jsep: jsep,\n                    tracks: [\n                        {type: 'data'}\n                    ],\n                    success: function(jsep) {\n                        Janus.debug(\"Got SDP!\");\n                        Janus.debug(jsep);\n                        let body = {request: \"start\", room: this.roomid};\n                        pluginHandle.send({message: body, jsep: jsep});\n                    },\n                    error: function(error) {\n                        Janus.error(\"WebRTC error:\", error);\n                        Notification.alert(\"WebRTC error... \", error.message);\n                    }\n                }\n            );\n        }\n    }\n\n    attachAudio(audioStream) {\n        Janus.attachMediaStream(\n            this.remoteVideo || document.getElementById('deft_venue_remote_audio'),\n            audioStream\n        );\n    }\n\n    attachVideo(videoStream) {\n        document.querySelectorAll('[data-region=\"deft-venue\"] video').forEach(video => {\n            video.classList.remove('hidden');\n        });\n        Janus.attachMediaStream(\n            this.remoteVideo || document.getElementById('deft_venue_remote_video'),\n            videoStream\n        );\n    }\n}\n"],"names":["_interopRequireDefault","e","__esModule","default","_ajax","_janusGateway","_publish","_log","_notification","Subscribe","Publish","startConnection","feed","this","current","transactions","creatingSubscription","remoteStreams","Janus","init","debug","callback","janus","server","iceServers","success","attach","plugin","opaqueId","randomString","pluginHandle","videoroom","register","error","restart","Notification","alert","ondata","data","message","JSON","parse","publish","request","subscribe","mid","send","onlocaltrack","onLocalTrack","bind","onmessage","onMessage","onremotetrack","track","on","metadata","reason","hasOwnProperty","kind","remoteAudioStream","MediaStream","Log","attachAudio","remoteStream","attachVideo","Ajax","call","args","handle","getId","id","Number","peerid","room","roomid","ptype","session","getSessionId","contextid","fail","exception","methodname","msg","jsep","event","log","webrtcUp","tracks","type","capture","recv","createOffer","video","audio","warn","window","close","error_code","createAnswer","body","audioStream","attachMediaStream","remoteVideo","document","getElementById","videoStream","querySelectorAll","forEach","classList","remove","_exports"],"mappings":"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"}