define("block_deft/venue_manager",["exports","core/ajax","core/fragment","core/notification","core/log","block_deft/socket"],(function(_exports,_ajax,_fragment,_notification,_log,_socket){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/*
   * Manage venue connections
   *
   * @package    block_deft
   * @module     block_deft/venue_manager
   * @copyright  2022 Daniel Thies <dethies@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_ajax=_interopRequireDefault(_ajax),_fragment=_interopRequireDefault(_fragment),_notification=_interopRequireDefault(_notification),_log=_interopRequireDefault(_log),_socket=_interopRequireDefault(_socket);var _default={lastSignal:0,lastUpdate:0,dataChannels:[],peerConnections:[],queue:[],queueout:[],init:function(contextid,token,peers,peerid,iceServers){this.contextid=contextid,this.peerid=peerid,this.iceServers=iceServers,this.audioInput=navigator.mediaDevices.getUserMedia({audio:{autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,sampleRate:8e3},video:!1}),document.querySelector("body").addEventListener("click",(e=>{const button=e.target.closest('a[data-action="mute"], a[data-action="unmute"]');if(button){const action=button.getAttribute("data-action");peerid=button.closest("[data-peerid]").getAttribute("data-peerid"),e.stopPropagation(),e.preventDefault(),peerid==this.peerid?(this.mute("mute"==action),_ajax.default.call([{args:{mute:"mute"==action,status:!1},fail:_notification.default.exception,methodname:"block_deft_venue_settings"}])):_ajax.default.call([{args:{mute:!0,peerid:peerid,status:!1},fail:_notification.default.exception,methodname:"block_deft_venue_settings"}]),button.closest("[data-peerid]").querySelectorAll('[data-action="mute"], [data-action="unmute"]').forEach((option=>{option.getAttribute("data-action")==action?option.classList.add("hidden"):option.classList.remove("hidden")}))}})),peers.forEach((peerid=>{const pc=new RTCPeerConnection({iceServers:iceServers}),dataChannel=pc.createDataChannel("Events");this.dataChannels.push(dataChannel),dataChannel.onmessage=this.handleMessage.bind(this,peerid),pc.onnegotiationneeded=this.negotiate.bind(this,contextid,pc,peerid),pc.onicecandidate=this.handleICECandidate.bind(this,contextid,peerid),pc.ontrack=this.handleTrackEvent.bind(this,peerid),pc.onconnectionstatechange=this.handleStateChange.bind(this,peerid),this.peerConnections[peerid]=pc})),document.querySelectorAll('a[data-action="raisehand"], a[data-action="lowerhand"]').forEach((button=>{button.addEventListener("click",(e=>{const action=button.getAttribute("data-action");e.stopPropagation(),e.preventDefault(),document.querySelectorAll('a[data-action="raisehand"], a[data-action="lowerhand"]').forEach((button=>{button.getAttribute("data-action")==action?button.classList.add("hidden"):button.classList.remove("hidden")})),_ajax.default.call([{args:{status:"raisehand"==action},fail:_notification.default.exception,methodname:"block_deft_raise_hand"}]),this.dataChannels.forEach((dataChannel=>{"open"==dataChannel.readyState&&("raisehand"==action?dataChannel.send('{"raisehand": true}'):dataChannel.send('{"raisehand": false}'))}))}))})),document.querySelectorAll('a[data-action="close"]').forEach((button=>{button.addEventListener("click",(e=>{e.stopPropagation(),e.preventDefault(),button.firstChild.classList.add("bg-warning"),this.closeConnections()}))})),window.onbeforeunload=this.closeConnections.bind(this),new _socket.default(contextid,token).subscribe((()=>{this.sendSignals()}))},handleICECandidate:function(contextid,peerid,e){e.candidate&&this.sendSignal(peerid,"new-ice-candidate",e.candidate)},sendSignal:function(peerid,type,message){this.queueout.push({message:JSON.stringify(message),peerid:peerid,type:type}),this.sendSignals()},sendSignals:function(){if(this.throttled||!navigator.onLine)return;const time=Date.now();if(this.lastUpdate+200>time)return this.throttled=!0,setTimeout((()=>{this.throttled=!1}),this.lastUpdate+250-time),void this.sendSignals();this.lastUpdate=time;const messages=[];for(;this.queueout.length;)messages.push(this.queueout.shift());_ajax.default.call([{args:{contextid:this.contextid,lastsignal:this.lastSignal,messages:messages},contextid:this.contextid,done:response=>{response.settings.forEach((peer=>{if(peer.id==Number(this.peerid)){if(peer.status)return void window.close();this.mute(peer.mute)}document.querySelectorAll('[data-peerid="'+peer.id+'"] [data-action="mute"], [data-peerid="'+peer.id+'"] [data-action="unmute"]').forEach((button=>{peer.mute==("mute"==button.getAttribute("data-action"))?button.classList.add("hidden"):button.classList.remove("hidden")}))})),response.messages.forEach((signal=>{signal.id>this.lastSignal&&(this.lastSignal=signal.id,this.processSignal(signal))}));for(const key in this.peerConnections.keys())if(!response.peers.includes(key)){const pc=this.peerConnections[key];_log.default.debug("Close "+key),pc.close(),this.peerConnections[key]=null}},fail:_notification.default.exception,methodname:"block_deft_send_signal"}])},negotiate:function(contextid,pc,peerid){return pc.createOffer().then((offer=>pc.setLocalDescription(offer).then((()=>this.sendSignal(peerid,"audio-offer",offer))).catch(_log.default.debug)))},processSignal:function(signal){if("audio-offer"===signal.type){const pc=this.peerConnections[signal.frompeer]||new RTCPeerConnection({iceServers:this.iceServers});this.peerConnections[signal.frompeer]||(this.peerConnections[signal.frompeer]=pc),_log.default.debug("Received offer"),pc.onnegotiationneeded=this.negotiate.bind(this,this.contextid,pc,signal.frompeer),pc.onicecandidate=this.handleICECandidate.bind(this,this.contextid,signal.frompeer),pc.ontrack=this.handleTrackEvent.bind(this,signal.frompeer),pc.onconnectionstatechange=this.handleStateChange.bind(this,signal.frompeer),pc.ondatachannel=e=>{this.dataChannels.push(e.channel),e.channel.onmessage=this.handleMessage.bind(this,signal.frompeer),e.channel.onopen=()=>{document.querySelector('[data-peerid="'+this.peerid+'"] a.hidden[data-action="raisehand"]')&&window.setTimeout((()=>{e.channel.send('{"raisehand": true}')}),3e3)}},pc.setRemoteDescription(JSON.parse(signal.message)).then((()=>(_log.default.debug("Set Remote"),this.audioInput.then((audioStream=>(_log.default.debug("audio stream"),pc.getTransceivers().length<2&&audioStream.getAudioTracks().forEach((track=>{pc.addTransceiver(track,{streams:[audioStream]})})),_log.default.debug("Create answer"),pc.createAnswer().then((answer=>(_log.default.debug("Answer created"),!(!pc||"stable"==pc.signalingState)&&pc.setLocalDescription(answer).then((()=>(_log.default.debug("Set local"),this.sendSignal(signal.frompeer,"audio-answer",answer)))).catch(_log.default.debug)))).catch(_notification.default.exception)))).catch(_notification.default.exception)))).catch(_log.default.debug)}else if("audio-answer"===signal.type){const pc=this.peerConnections[signal.frompeer];_log.default.debug("Audio answer"),pc&&"have-local-offer"==pc.signalingState&&pc.setRemoteDescription(JSON.parse(signal.message))}else if("new-ice-candidate"===signal.type){const pc=this.peerConnections[signal.frompeer]||null;pc&&pc.currentRemoteDescription&&pc.addIceCandidate(JSON.parse(signal.message))}},handleTrackEvent:function(peerid,e){if(!e||!e.streams||document.querySelector('#deft_audio div[data-peerid="'+peerid+'"]'))return;_log.default.debug("Track"),_log.default.debug(e);const node=document.createElement("div");node.setAttribute("data-peerid",peerid),node.setAttribute("class","col col-12 col-md-6 col-lg-4 col-xl-3 m-2"),window.setTimeout((()=>{node.querySelectorAll("img.card-img-top").forEach((image=>{image.setAttribute("height",null),image.setAttribute("width",null)}))})),document.querySelector("#deft_audio").appendChild(node),_fragment.default.loadFragment("block_deft","venue",this.contextid,{peerid:peerid}).done((userinfo=>{node.innerHTML=userinfo;node.querySelector("audio").srcObject=e.streams[0]})).catch(_notification.default.exception)},mute:function(state){this.audioInput.then((audioStream=>(audioStream.getAudioTracks().forEach((track=>{track.enabled==state&&(track.enabled=!state)})),!0))).catch(_notification.default.exception)},handleMessage:function(peerid,e){const message=JSON.parse(e.data);document.querySelectorAll('[data-peerid="'+peerid+'"] [data-action="raisehand"]').forEach((button=>{message.raisehand?button.classList.add("hidden"):button.classList.remove("hidden")})),document.querySelectorAll('[data-peerid="'+peerid+'"] [data-action="lowerhand"]').forEach((button=>{message.raisehand?button.classList.remove("hidden"):button.classList.add("hidden")}))},handleStateChange(peerid){const pc=this.peerConnections[peerid];document.querySelectorAll('#deft_audio div[data-peerid="'+peerid+'"]').forEach((userinfo=>{switch(pc.connectionState){case"connected":userinfo.classList.remove("hidden");break;case"close":case"failed":userinfo.remove();break;case"disconnected":userinfo.classList.add("hidden")}}))},closeConnections(){_ajax.default.call([{args:{mute:!1,status:!0},fail:_notification.default.exception,methodname:"block_deft_venue_settings"}]),this.peerConnections.forEach((pc=>{pc.close()})),this.audioInput.then((audioStream=>(audioStream.getAudioTracks().forEach((track=>{track.stop()})),!0))).catch(_notification.default.exception),window.beforeunload=null}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=venue_manager.min.js.map