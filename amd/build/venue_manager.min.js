define("block_deft/venue_manager",["exports","core/ajax","core/fragment","core/notification","core/log","block_deft/socket"],(function(_exports,_ajax,_fragment,_notification,_log,_socket){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/*
   * Manage venue connections
   *
   * @package    block_deft
   * @module     block_deft/venue_manager
   * @copyright  2022 Daniel Thies <dethies@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_ajax=_interopRequireDefault(_ajax),_fragment=_interopRequireDefault(_fragment),_notification=_interopRequireDefault(_notification),_log=_interopRequireDefault(_log),_socket=_interopRequireDefault(_socket);var _default={lastSignal:0,lastUpdate:0,dataChannels:[],peerConnections:[],queue:[],queueout:[],init:function(contextid,token,peers,peerid,iceServers){this.contextid=contextid,this.peerid=peerid,this.iceServers=iceServers,this.audioInput=navigator.mediaDevices.getUserMedia({audio:{autoGainControl:!1,echoCancellation:!0,noiseSuppression:!0,sampleRate:22050},video:!1}),document.querySelector("body").addEventListener("click",(e=>{const button=e.target.closest('a[data-action="mute"], a[data-action="unmute"]');if(button){const action=button.getAttribute("data-action");peerid=button.closest("[data-peerid]").getAttribute("data-peerid"),e.stopPropagation(),peerid==this.peerid&&(this.mute("mute"==action),_ajax.default.call([{args:{mute:"mute"==action,status:!1},fail:_notification.default.exception,methodname:"block_deft_venue_settings"}])),button.closest("[data-peerid]").querySelectorAll('[data-action="mute"], [data-action="unmute"]').forEach((option=>{option.getAttribute("data-action")==action?option.classList.add("hidden"):option.classList.remove("hidden")}))}})),peers.forEach((peerid=>{const pc=new RTCPeerConnection({iceServers:iceServers}),dataChannel=pc.createDataChannel("Events");this.dataChannels.push(dataChannel),this.audioInput.then((audioStream=>(audioStream.getAudioTracks().forEach((track=>{pc.addTrack(track,audioStream)})),!0))).catch(_notification.default.exception),dataChannel.onmessage=this.handleMessage.bind(this,peerid),pc.onnegotiationneeded=this.negotiate.bind(this,contextid,pc,peerid),pc.onicecandidate=this.handleICECandidate.bind(this,contextid,peerid),pc.ontrack=this.handleTrackEvent.bind(this,peerid),pc.onconnectionstatechange=this.handleStateChange.bind(this,peerid),this.peerConnections[peerid]=pc})),document.querySelectorAll('a[data-action="raisehand"], a[data-action="lowerhand"]').forEach((button=>{button.addEventListener("click",(()=>{const action=button.getAttribute("data-action");document.querySelectorAll('a[data-action="raisehand"], a[data-action="lowerhand"]').forEach((button=>{button.getAttribute("data-action")==action?button.classList.add("hidden"):button.classList.remove("hidden")})),this.dataChannels.forEach((dataChannel=>{"open"==dataChannel.readyState&&("raisehand"==action?dataChannel.send('{"raisehand": true}'):dataChannel.send('{"raisehand": false}'))}))}))})),new _socket.default(contextid,token).subscribe((()=>{this.sendSignals()}))},handleICECandidate:function(contextid,peerid,e){e.candidate&&this.sendSignal(peerid,"new-ice-candidate",e.candidate)},sendSignal:function(peerid,type,message){this.queueout.push({message:JSON.stringify(message),peerid:peerid,type:type}),this.sendSignals()},sendSignals:function(){if(this.throttled)return;const time=Date.now();if(this.lastUpdate+200>time)return this.throttled=!0,setTimeout((()=>{this.throttled=!1}),this.lastUpdate+250-time),void this.sendSignals();this.lastUpdate=time;const messages=[];for(;this.queueout.length;)messages.push(this.queueout.shift());_ajax.default.call([{args:{contextid:this.contextid,lastsignal:this.lastSignal,messages:messages},contextid:this.contextid,done:response=>{response.settings.forEach((peer=>{if(peer.id==Number(this.peerid)){if(peer.status)return void window.close();this.mute(peer.mute)}document.querySelectorAll('[data-peerid="'+peer.id+'"] [data-action="mute"], [data-peerid="'+peer.id+'"] [data-action="unmute"]').forEach((button=>{peer.mute==("mute"==button.getAttribute("data-action"))?button.classList.add("hidden"):button.classList.remove("hidden")}))})),response.messages.forEach((signal=>{signal.id>this.lastSignal&&(this.lastSignal=signal.id,this.queue.push(signal))})),!this.processing&&this.queue.length&&(this.processing=!0,this.processSignal())},fail:_notification.default.exception,methodname:"block_deft_send_signal"}])},negotiate:function(contextid,pc,peerid){return pc.createOffer().then((offer=>pc.setLocalDescription(offer).then((()=>this.sendSignal(peerid,"audio-offer",offer)))))},processSignal:function(){const signal=this.queue.shift();if(!signal)return this.processing=!1,Promise.resolve(!0);if("audio-offer"===signal.type){const pc=this.peerConnections[signal.frompeer]||new RTCPeerConnection({iceServers:this.iceServers});return this.peerConnections[signal.frompeer]||(this.peerConnections[signal.frompeer]=pc),_log.default.debug("Received offer"),pc.onnegotiationneeded=this.negotiate.bind(this,this.contextid,pc,signal.frompeer),pc.onicecandidate=this.handleICECandidate.bind(this,this.contextid,signal.frompeer),pc.ontrack=this.handleTrackEvent.bind(this,signal.frompeer),pc.onconnectionstatechange=this.handleStateChange.bind(this,signal.frompeer),pc.ondatachannel=e=>{this.dataChannels.push(e.channel),e.channel.onmessage=this.handleMessage.bind(this,signal.frompeer)},pc.setRemoteDescription(JSON.parse(signal.message)).then((()=>{_log.default.debug("Set Remote"),this.audioInput.then((audioStream=>{_log.default.debug("audio stream"),audioStream.getAudioTracks().forEach((track=>{pc.addTransceiver(track,{streams:[audioStream]})})),_log.default.debug("Create answer"),pc.createAnswer().then((answer=>{_log.default.debug("Answer created"),"stable"!=pc.signalingState&&pc.setLocalDescription(answer).then((()=>{_log.default.debug("Set local"),this.sendSignal(signal.frompeer,"audio-answer",answer)})).catch((e=>{_log.default.debug(e),this.processSignal()}))})).catch(_notification.default.exception)})).catch(_notification.default.exception)})).catch((e=>{_log.default.debug(e),this.processSignal()})).then((()=>{this.processSignal()})).catch(_notification.default.exception)}if("audio-answer"===signal.type){const pc=this.peerConnections[signal.frompeer];if(_log.default.debug("Audio answer"),"have-local-offer"==pc.signalingState)return pc.setRemoteDescription(JSON.parse(signal.message)).then((()=>(_log.default.debug("Set Remote"),this.processSignal()))).catch((e=>(_log.default.debug(e),this.processSignal())))}else if("new-ice-candidate"===signal.type){const pc=this.peerConnections[signal.frompeer]||null;if(pc)return pc.addIceCandidate(JSON.parse(signal.message)).then((()=>{this.processSignal()})).catch(_notification.default.exception)}return this.processSignal()},handleTrackEvent:function(peerid,e){if(!e||!e.streams||document.querySelector('#deft_audio div[data-peerid="'+peerid+'"]'))return;const node=document.createElement("div");node.setAttribute("data-peerid",peerid),node.setAttribute("class","col-4 col-md-3 col-xl-2 m-2"),window.setTimeout((()=>{node.querySelectorAll("img.card-img-top").forEach((image=>{image.setAttribute("height",null),image.setAttribute("width",null)}))})),document.querySelector("#deft_audio").appendChild(node),_fragment.default.loadFragment("block_deft","venue",this.contextid,{peerid:peerid}).done((userinfo=>{node.innerHTML=userinfo;node.querySelector("audio").srcObject=e.streams[0]})).catch(_notification.default.exception)},mute:function(state){this.audioInput.then((audioStream=>(audioStream.getAudioTracks().forEach((track=>{track.enabled==state&&(track.enabled=!state)})),!0))).catch(_notification.default.exception)},handleMessage:function(peerid,e){const message=JSON.parse(e.data);document.querySelectorAll('[data-peerid="'+peerid+'"] [data-action="raisehand"]').forEach((button=>{message.raisehand?button.classList.add("hidden"):button.classList.remove("hidden")})),document.querySelectorAll('[data-peerid="'+peerid+'"] [data-action="lowerhand"]').forEach((button=>{message.raisehand?button.classList.remove("hidden"):button.classList.add("hidden")}))},handleStateChange(peerid){switch(this.peerConnections[peerid].connectionState){case"connected":document.querySelectorAll('#deft_audio div[data-peerid="'+peerid+'"]').forEach((userinfo=>{userinfo.classList.remove("hidden")}));break;case"close":case"disconnected":case"failed":document.querySelectorAll('#deft_audio div[data-peerid="'+peerid+'"]').forEach((userinfo=>{userinfo.classList.add("hidden")}))}}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=venue_manager.min.js.map