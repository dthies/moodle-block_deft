define("block_deft/venue_manager",["exports","core/ajax","core/fragment","core/str","core/modal_events","core/notification","core/log","block_deft/socket","core/adapter"],(function(_exports,_ajax,_fragment,_str,_modal_events,_notification,_log,_socket,_adapter){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/*
   * Manage venue connections
   *
   * @package    block_deft
   * @module     block_deft/venue_manager
   * @copyright  2022 Daniel Thies <dethies@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_ajax=_interopRequireDefault(_ajax),_fragment=_interopRequireDefault(_fragment),_modal_events=_interopRequireDefault(_modal_events),_notification=_interopRequireDefault(_notification),_log=_interopRequireDefault(_log),_socket=_interopRequireDefault(_socket);return _exports.default=class{constructor(contextid,token,peers,peerid,iceServers){if(this.contextid=contextid,this.peerid=peerid,this.iceServers=iceServers,this.lastSignal=0,this.lastUpdate=0,this.dataChannels=[],this.peerConnections=[],this.queueout=[],!window.RTCPeerConnection)return document.querySelectorAll(".venue_manager").forEach((venue=>{const e=new Event("venueclosed",{bubbles:!0});venue.dispatchEvent(e)})),void _notification.default.alert((0,_str.get_string)("unsupportedbrowser","block_deft"),(0,_str.get_string)("unsupportedbrowsermessage","block_deft")).then((notice=>{notice.getRoot().on(_modal_events.default.cancel,(()=>{_ajax.default.call([{args:{mute:!1,status:!0},fail:_notification.default.exception,methodname:"block_deft_venue_settings"}])[0].then((()=>{window.close()}))}))}));this.audioInput=navigator.mediaDevices.getUserMedia({audio:{autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0,sampleRate:8e3},video:!1}).catch((e=>(_log.default.debug(e),_ajax.default.call([{args:{mute:!0,status:!1},fail:_notification.default.exception,methodname:"block_deft_venue_settings"}]),!1))),this.audioInput.then(this.monitorVolume.bind(this)),document.querySelector("body").removeEventListener("click",this.handleMuteButtons),document.querySelector("body").addEventListener("click",this.handleMuteButtons),peers.forEach((peerid=>{const pc=new RTCPeerConnection({iceServers:iceServers}),dataChannel=pc.createDataChannel("Events");this.dataChannels.push(dataChannel),dataChannel.onmessage=this.handleMessage.bind(this,peerid),pc.onnegotiationneeded=this.negotiate.bind(this,contextid,pc,peerid),pc.onicecandidate=this.handleICECandidate.bind(this,contextid,peerid),pc.ontrack=this.handleTrackEvent.bind(this,peerid),pc.onconnectionstatechange=this.handleStateChange.bind(this,peerid),this.peerConnections[peerid]=pc})),document.querySelector("body").removeEventListener("click",this.handleRaiseHand.bind(this)),document.querySelector("body").addEventListener("click",this.handleRaiseHand.bind(this)),document.querySelector("body").removeEventListener("click",this.closeConnections.bind(this)),document.querySelector("body").addEventListener("click",this.closeConnections.bind(this)),window.onbeforeunload=this.closeConnections.bind(this),this.socket=new _socket.default(contextid,token),this.socket.subscribe((()=>{this.sendSignals()}))}handleICECandidate(contextid,peerid,e){e.candidate&&this.sendSignal(peerid,"new-ice-candidate",e.candidate)}sendSignal(peerid,type,message){this.queueout.push({message:JSON.stringify(message),peerid:peerid,type:type}),this.sendSignals()}sendSignals(){if(this.throttled||!navigator.onLine)return;const time=Date.now();if(this.lastUpdate+200>time)return this.throttled=!0,setTimeout((()=>{this.throttled=!1}),this.lastUpdate+250-time),void this.sendSignals();this.lastUpdate=time;const messages=[];for(;this.queueout.length;)messages.push(this.queueout.shift());_ajax.default.call([{args:{contextid:this.contextid,lastsignal:this.lastSignal,messages:messages},contextid:this.contextid,done:response=>{response.settings.forEach((peer=>{if(peer.id==Number(this.peerid)){if(peer.status)return clearInterval(this.meterId),this.audioInput.then((audioStream=>(audioStream&&audioStream.getAudioTracks().forEach((track=>{track.stop()})),audioStream))).catch(_notification.default.exception),this.peerConnections.forEach((pc=>{pc.close()})),document.querySelectorAll('[data-region="deft-venue"] [data-peerid="'+this.peerid+'"]').forEach((venue=>{const e=new Event("venueclosed",{bubbles:!0});venue.dispatchEvent(e)})),this.socket.disconnect(),void window.close();this.mute(peer.mute)}document.querySelectorAll('[data-peerid="'+peer.id+'"] [data-action="mute"], [data-peerid="'+peer.id+'"] [data-action="unmute"]').forEach((button=>{peer.mute==("mute"==button.getAttribute("data-action"))?button.classList.add("hidden"):button.classList.remove("hidden")}))})),response.messages.forEach((signal=>{signal.id>this.lastSignal&&(this.lastSignal=signal.id,this.processSignal(signal))}));for(const key in this.peerConnections.keys())if(!response.peers.includes(key)){this.peerConnections[key].close()}},fail:_notification.default.exception,methodname:"block_deft_send_signal"}])}negotiate(contextid,pc,peerid){return pc.createOffer().then((offer=>pc.setLocalDescription(offer).then((()=>this.sendSignal(peerid,"audio-offer",offer))).catch(_log.default.debug)))}processSignal(signal){if("audio-offer"===signal.type){const pc=this.peerConnections[signal.frompeer]||new RTCPeerConnection({iceServers:this.iceServers});this.peerConnections[signal.frompeer]||(this.peerConnections[signal.frompeer]=pc),_log.default.debug("Received offer"),pc.onnegotiationneeded=this.negotiate.bind(this,this.contextid,pc,signal.frompeer),pc.onicecandidate=this.handleICECandidate.bind(this,this.contextid,signal.frompeer),pc.ontrack=this.handleTrackEvent.bind(this,signal.frompeer),pc.onconnectionstatechange=this.handleStateChange.bind(this,signal.frompeer),pc.ondatachannel=e=>{this.dataChannels.push(e.channel),e.channel.onmessage=this.handleMessage.bind(this,signal.frompeer),e.channel.onopen=()=>{document.querySelector('[data-peerid="'+this.peerid+'"] a.hidden[data-action="raisehand"]')&&window.setTimeout((()=>{e.channel.send('{"raisehand": true}')}),3e3)}},pc.setRemoteDescription(JSON.parse(signal.message)).then((()=>(_log.default.debug("Set Remote"),this.audioInput.then((audioStream=>(audioStream&&(_log.default.debug("audio stream"),pc.getTransceivers().length<2&&audioStream.getAudioTracks().forEach((track=>{pc.addTransceiver(track,{streams:[audioStream]})}))),_log.default.debug("Create answer"),pc.createAnswer().then((answer=>(_log.default.debug("Answer created"),!(!pc||"stable"==pc.signalingState)&&pc.setLocalDescription(answer).then((()=>(_log.default.debug("Set local"),this.sendSignal(signal.frompeer,"audio-answer",answer)))).catch(_log.default.debug)))).catch(_notification.default.exception)))).catch(_notification.default.exception)))).catch(_log.default.debug)}else if("audio-answer"===signal.type){const pc=this.peerConnections[signal.frompeer];_log.default.debug("Audio answer"),pc&&"have-local-offer"==pc.signalingState&&pc.setRemoteDescription(JSON.parse(signal.message))}else if("new-ice-candidate"===signal.type){const pc=this.peerConnections[signal.frompeer]||null;pc&&pc.currentRemoteDescription&&pc.addIceCandidate(JSON.parse(signal.message))}}handleTrackEvent(peerid,e){if(!e||!e.streams||!document.querySelector("#deft_audio")||document.querySelector('#deft_audio div[data-peerid="'+peerid+'"]'))return;const node=document.createElement("div");node.setAttribute("data-peerid",peerid),document.querySelector("body#page-blocks-deft-venue")?node.setAttribute("class","col col-12 col-md-6 col-lg-4 col-xl-3 m-2"):node.setAttribute("class","col col-12 m-2"),window.setTimeout((()=>{node.querySelectorAll("img.card-img-top").forEach((image=>{image.setAttribute("height",null),image.setAttribute("width",null)}))})),document.querySelector("#deft_audio").appendChild(node),_fragment.default.loadFragment("block_deft","venue",this.contextid,{peerid:peerid}).done((userinfo=>{node.innerHTML=userinfo;node.querySelector("audio").srcObject=e.streams[0]})).catch(_notification.default.exception)}mute(state){this.audioInput.then((audioStream=>audioStream?(audioStream.getAudioTracks().forEach((track=>{track.enabled==state&&(track.enabled=!state)})),!0):this.audioInput)).catch(_notification.default.exception)}handleMessage(peerid,e){const message=JSON.parse(e.data);message.hasOwnProperty("raisehand")&&(document.querySelectorAll('[data-peerid="'+peerid+'"] [data-action="raisehand"]').forEach((button=>{message.raisehand?button.classList.add("hidden"):button.classList.remove("hidden")})),document.querySelectorAll('[data-peerid="'+peerid+'"] [data-action="lowerhand"]').forEach((button=>{message.raisehand?button.classList.remove("hidden"):button.classList.add("hidden")}))),message.hasOwnProperty("volume")&&document.querySelectorAll('.volume_indicator[data-peerid="'+peerid+'"]').forEach((indicator=>{indicator.querySelector(".low").style.opacity=message.volume.low,indicator.querySelector(".mid").style.opacity=message.volume.mid,indicator.querySelector(".high").style.opacity=message.volume.high}))}handleStateChange(peerid){const pc=this.peerConnections[peerid];document.querySelectorAll('#deft_audio div[data-peerid="'+peerid+'"]').forEach((userinfo=>{switch(pc.connectionState){case"connected":userinfo.classList.remove("hidden");break;case"close":case"failed":userinfo.remove();break;case"disconnected":userinfo.classList.add("hidden")}}))}closeConnections(e){if(e&&"click"==e.type){if(!e.target.closest('[data-region="deft-venue"] a[data-action="close"]'))return;e.stopPropagation(),e.preventDefault()}document.querySelectorAll('[data-region="deft-venue"] a[data-action="close"] i').forEach((button=>{button.classList.add("bg-warning")})),_ajax.default.call([{args:{mute:!1,status:!0},fail:_notification.default.exception,methodname:"block_deft_venue_settings"}]),clearInterval(this.meterId),this.audioInput.then((audioStream=>(audioStream&&audioStream.getAudioTracks().forEach((track=>{track.stop()})),!0))).catch(_notification.default.exception),this.peerConnections.forEach((pc=>{pc.close()})),document.querySelectorAll('.deft-venue [data-peerid="'+this.peerid+'"]').forEach((venue=>{const event=new Event("venueclosed");venue.despatchEvent(event)})),window.beforeunload=null}handleMuteButtons(e){const button=e.target.closest('a[data-action="mute"], a[data-action="unmute"]');if(button){const action=button.getAttribute("data-action"),peerid=button.closest("[data-peerid]").getAttribute("data-peerid");e.stopPropagation(),e.preventDefault(),button.closest("#deft_audio")?_ajax.default.call([{args:{mute:!0,peerid:peerid,status:!1},fail:_notification.default.exception,methodname:"block_deft_venue_settings"}]):_ajax.default.call([{args:{mute:"mute"==action,status:!1},fail:_notification.default.exception,methodname:"block_deft_venue_settings"}]),button.closest("[data-peerid]").querySelectorAll('[data-action="mute"], [data-action="unmute"]').forEach((option=>{option.getAttribute("data-action")==action?option.classList.add("hidden"):option.classList.remove("hidden")}))}}handleRaiseHand(e){const button=e.target.closest('a[data-action="raisehand"], a[data-action="lowerhand"]');if(button){const action=button.getAttribute("data-action");e.stopPropagation(),e.preventDefault(),document.querySelectorAll('a[data-action="raisehand"], a[data-action="lowerhand"]').forEach((button=>{button.getAttribute("data-action")==action?button.classList.add("hidden"):button.classList.remove("hidden")})),_ajax.default.call([{args:{status:"raisehand"==action},fail:_notification.default.exception,methodname:"block_deft_raise_hand"}]),this.dataChannels.forEach((dataChannel=>{"open"==dataChannel.readyState&&("raisehand"==action?dataChannel.send('{"raisehand": true}'):dataChannel.send('{"raisehand": false}'))}))}}monitorVolume(audioStream){if(audioStream){const audioContext=new AudioContext,source=audioContext.createMediaStreamSource(audioStream),analyser=new AnalyserNode(audioContext,{maxDecibels:-50,minDecibels:-90,fftSize:2048,smoothingTimeConstant:.3}),bufferLength=analyser.frequencyBinCount,data=new Uint8Array(bufferLength);source.connect(analyser),this.meterId=setInterval((()=>{analyser.getByteFrequencyData(data);const volume={low:Math.min(1,data.slice(0,16).reduce(((a,b)=>a+b),0)/2e3),mid:Math.min(1,data.slice(17,31).reduce(((a,b)=>a+b),0)/1e3),high:Math.min(1,data.slice(32).reduce(((a,b)=>a+b),0)/4e3)},message=JSON.stringify({volume:volume}),peers=[];document.querySelectorAll('.volume_indicator[data-peerid="'+this.peerid+'"]').forEach((indicator=>{indicator.querySelectorAll(".low").forEach((low=>{low.style.opacity=volume.low})),indicator.querySelectorAll(".mid").forEach((mid=>{mid.style.opacity=volume.mid})),indicator.querySelectorAll(".high").forEach((high=>{high.style.opacity=volume.high}))})),this.dataChannels.forEach((dataChannel=>{"open"==dataChannel.readyState&&dataChannel.send(message)})),document.querySelectorAll("#deft_audio > div").forEach((peer=>{peers.push(peer)})),peers.sort(((a,b)=>{let volume=0;return a.querySelectorAll(".high, .mid, .low").forEach((indicator=>{volume+=-indicator.style.opacity})),b.querySelectorAll(".high, .mid, .low").forEach((indicator=>{volume+=indicator.style.opacity})),volume})),peers.forEach((peer=>{document.querySelector("#deft_audio").appendChild(peer)}))}),100)}return audioStream}},_exports.default}));

//# sourceMappingURL=venue_manager.min.js.map