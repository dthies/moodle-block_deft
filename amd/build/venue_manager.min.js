define("block_deft/venue_manager",["exports","core/ajax","core/fragment","core/str","core/modal_events","core/notification","core/log","block_deft/socket","core/adapter"],(function(_exports,_ajax,_fragment,_str,_modal_events,_notification,_log,_socket,_adapter){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_ajax=_interopRequireDefault(_ajax),_fragment=_interopRequireDefault(_fragment),_modal_events=_interopRequireDefault(_modal_events),_notification=_interopRequireDefault(_notification),_log=_interopRequireDefault(_log),_socket=_interopRequireDefault(_socket);var _default=function(){function _default(contextid,token,peers,peerid,iceServers,autogaincontrol,echocancellation,noisesuppression,samplerate){var _this=this;if(function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}(this,_default),this.contextid=contextid,this.peerid=peerid,this.iceServers=iceServers,this.autogaincontrol=autogaincontrol,this.echocancellation=echocancellation,this.noisesuppression=noisesuppression,this.samplerate=samplerate,this.lastSignal=0,this.lastUpdate=0,this.dataChannels=[],this.peerConnections={},this.queueout=[],!window.RTCPeerConnection)return document.querySelectorAll(".venue_manager").forEach((function(venue){var e=new Event("venueclosed",{bubbles:!0});venue.dispatchEvent(e)})),void _notification.default.alert((0,_str.get_string)("unsupportedbrowser","block_deft"),(0,_str.get_string)("unsupportedbrowsermessage","block_deft")).then((function(notice){return notice.getRoot().on(_modal_events.default.cancel,(function(){return _ajax.default.call([{args:{mute:!1,status:!0},fail:_notification.default.exception,methodname:"block_deft_venue_settings"}])[0].then((function(status){return window.close(),status}))})),notice})).fail(_notification.default.exception);this.audioInput=navigator.mediaDevices.getUserMedia({audio:{autoGainControl:autogaincontrol,echoCancellation:echocancellation,noiseSuppression:noisesuppression,sampleRate:samplerate},video:!1}).catch((function(e){return _log.default.debug(e),_ajax.default.call([{args:{mute:!0,status:!1},fail:_notification.default.exception,methodname:"block_deft_venue_settings"}]),!1})),this.audioInput.then(this.monitorVolume.bind(this)).catch(_log.default.debug),document.querySelector("body").removeEventListener("click",this.handleMuteButtons.bind(this)),document.querySelector("body").addEventListener("click",this.handleMuteButtons.bind(this)),peers.forEach((function(peerid){var pc=new RTCPeerConnection({iceServers:iceServers}),dataChannel=pc.createDataChannel("Events");_this.dataChannels.push(dataChannel),dataChannel.onmessage=_this.handleMessage.bind(_this,peerid),pc.onnegotiationneeded=_this.negotiate.bind(_this,contextid,pc,peerid),pc.onicecandidate=_this.handleICECandidate.bind(_this,contextid,peerid),pc.ontrack=_this.handleTrackEvent.bind(_this,peerid),pc.onconnectionstatechange=_this.handleStateChange.bind(_this,peerid),_this.peerConnections[String(peerid)]=pc})),document.querySelector("body").removeEventListener("click",this.handleRaiseHand.bind(this)),document.querySelector("body").addEventListener("click",this.handleRaiseHand.bind(this)),document.querySelector("body").removeEventListener("click",this.closeConnections.bind(this)),document.querySelector("body").addEventListener("click",this.closeConnections.bind(this)),window.onbeforeunload=this.closeConnections.bind(this),this.socket=new _socket.default(contextid,token),this.socket.subscribe((function(){_this.sendSignals()}))}var Constructor,protoProps,staticProps;return Constructor=_default,(protoProps=[{key:"handleICECandidate",value:function(contextid,peerid,e){e.candidate&&this.sendSignal(peerid,"new-ice-candidate",e.candidate)}},{key:"sendSignal",value:function(peerid,type,message){this.queueout.push({message:JSON.stringify(message),peerid:peerid,type:type}),this.sendSignals()}},{key:"sendSignals",value:function(){var _this2=this;if(!this.throttled&&navigator.onLine){var time=Date.now();if(this.lastUpdate+200>time)return this.throttled=!0,setTimeout((function(){_this2.throttled=!1}),this.lastUpdate+250-time),void this.sendSignals();this.lastUpdate=time;for(var messages=[];this.queueout.length;)messages.push(this.queueout.shift());_ajax.default.call([{args:{contextid:this.contextid,lastsignal:this.lastSignal,messages:messages},contextid:this.contextid,done:function(response){if(response.settings.forEach((function(peer){if(peer.id==Number(_this2.peerid)){if(peer.status)return clearInterval(_this2.meterId),_this2.audioInput.then((function(audioStream){return audioStream&&audioStream.getAudioTracks().forEach((function(track){track.stop()})),audioStream})).catch(_notification.default.exception),Object.values(_this2.peerConnections).forEach((function(pc){pc.close()})),document.querySelectorAll('[data-region="deft-venue"] [data-peerid="'+_this2.peerid+'"]').forEach((function(venue){var e=new Event("venueclosed",{bubbles:!0});venue.dispatchEvent(e)})),_this2.socket.disconnect(),void window.close();_this2.mute(peer.mute)}document.querySelectorAll('[data-peerid="'+peer.id+'"] [data-action="mute"], [data-peerid="'+peer.id+'"] [data-action="unmute"]').forEach((function(button){peer.mute==("mute"==button.getAttribute("data-action"))?button.classList.add("hidden"):button.classList.remove("hidden")}))})),response.peers.includes(Number(_this2.peerid)))for(var key in response.messages.forEach((function(signal){signal.id>_this2.lastSignal&&(_this2.lastSignal=signal.id,_this2.processSignal(signal))})),Object.keys(_this2.peerConnections))!response.peers.includes(Number(key))&&_this2.peerConnections[key]&&_this2.peerConnections[key].close()},fail:_notification.default.exception,methodname:"block_deft_send_signal"}])}}},{key:"negotiate",value:function(contextid,pc,peerid){var _this3=this;return pc.createOffer().then((function(offer){return pc.setLocalDescription(offer).then((function(){return _this3.sendSignal(peerid,"audio-offer",offer)})).catch(_log.default.debug)}))}},{key:"processSignal",value:function(signal){var _this4=this;if("audio-offer"===signal.type){var pc=this.peerConnections[String(signal.frompeer)]||new RTCPeerConnection({iceServers:this.iceServers});this.peerConnections[String(signal.frompeer)]||(this.peerConnections[String(signal.frompeer)]=pc),_log.default.debug("Received offer"),pc.onnegotiationneeded=this.negotiate.bind(this,this.contextid,pc,signal.frompeer),pc.onicecandidate=this.handleICECandidate.bind(this,this.contextid,signal.frompeer),pc.ontrack=this.handleTrackEvent.bind(this,signal.frompeer),pc.onconnectionstatechange=this.handleStateChange.bind(this,signal.frompeer),pc.ondatachannel=function(e){_this4.peerAudioPlayer(signal.frompeer),_this4.dataChannels.push(e.channel),e.channel.onmessage=_this4.handleMessage.bind(_this4,signal.frompeer),e.channel.onopen=function(){window.setTimeout((function(){e.channel.send(JSON.stringify({raisehand:!!document.querySelector('[data-peerid="'+_this4.peerid+'"] a.hidden[data-action="raisehand"]')}))}),3e3)}},pc.setRemoteDescription(JSON.parse(signal.message)).then((function(){return _log.default.debug("Set Remote"),_this4.audioInput.then((function(audioStream){return audioStream&&(_log.default.debug("audio stream"),pc.getTransceivers().length<2&&audioStream.getAudioTracks().forEach((function(track){pc.addTransceiver(track,{streams:[audioStream]})}))),_log.default.debug("Create answer"),pc.createAnswer().then((function(answer){return _log.default.debug("Answer created"),!(!pc||"stable"==pc.signalingState)&&pc.setLocalDescription(answer).then((function(){return _log.default.debug("Set local"),_this4.sendSignal(signal.frompeer,"audio-answer",answer)})).catch(_log.default.debug)})).catch(_notification.default.exception)})).catch(_notification.default.exception)})).catch(_log.default.debug)}else if("audio-answer"===signal.type){var _pc=this.peerConnections[String(signal.frompeer)];_log.default.debug("Audio answer"),_pc&&"have-local-offer"==_pc.signalingState&&_pc.setRemoteDescription(JSON.parse(signal.message))}else if("new-ice-candidate"===signal.type){var _pc2=this.peerConnections[String(signal.frompeer)]||null;_pc2&&_pc2.currentRemoteDescription&&_pc2.addIceCandidate(JSON.parse(signal.message))}}},{key:"handleTrackEvent",value:function(peerid,e){e&&e.streams&&document.querySelector("#deft_audio")&&this.peerAudioPlayer(peerid).then((function(player){player.srcObject||(player.srcObject=e.streams[0])})).catch(_notification.default.exception)}},{key:"mute",value:function(state){var _this5=this;this.audioInput.then((function(audioStream){return audioStream?(audioStream.getAudioTracks().forEach((function(track){track.enabled==state&&(track.enabled=!state)})),!0):_this5.audioInput})).catch(_notification.default.exception)}},{key:"handleMessage",value:function(peerid,e){var message=JSON.parse(e.data);message.hasOwnProperty("raisehand")&&(document.querySelectorAll('[data-peerid="'+peerid+'"] [data-action="raisehand"]').forEach((function(button){message.raisehand?button.classList.add("hidden"):button.classList.remove("hidden")})),document.querySelectorAll('[data-peerid="'+peerid+'"] [data-action="lowerhand"]').forEach((function(button){message.raisehand?button.classList.remove("hidden"):button.classList.add("hidden")}))),message.hasOwnProperty("volume")&&document.querySelectorAll('.volume_indicator[data-peerid="'+peerid+'"]').forEach((function(indicator){indicator.querySelector(".low").style.opacity=message.volume.low,indicator.querySelector(".mid").style.opacity=message.volume.mid,indicator.querySelector(".high").style.opacity=message.volume.high})),this.peerAudioPlayer(peerid)}},{key:"handleStateChange",value:function(peerid){var pc=this.peerConnections[String(peerid)];document.querySelectorAll('#deft_audio div[data-peerid="'+peerid+'"]').forEach((function(userinfo){switch(pc.connectionState){case"connected":userinfo.classList.remove("hidden");break;case"close":case"failed":userinfo.remove();break;case"disconnected":userinfo.classList.add("hidden")}}))}},{key:"closeConnections",value:function(e){if(e&&"click"==e.type){if(!e.target.closest('[data-region="deft-venue"] a[data-action="close"]'))return;e.stopPropagation(),e.preventDefault()}document.querySelectorAll('[data-region="deft-venue"] a[data-action="close"] i').forEach((function(button){button.classList.add("bg-danger")})),document.querySelector("body").classList.remove("block_deft_raisehand"),_ajax.default.call([{args:{mute:!1,status:!0},fail:_notification.default.exception,methodname:"block_deft_venue_settings"}]),clearInterval(this.meterId),this.audioInput.then((function(audioStream){return audioStream&&audioStream.getAudioTracks().forEach((function(track){track.stop()})),!0})).catch(_notification.default.exception),Object.values(this.peerConnections).forEach((function(pc){pc.close()})),document.querySelectorAll('.deft-venue [data-peerid="'+this.peerid+'"]').forEach((function(venue){var event=new Event("venueclosed");venue.dispatchEvent(event)})),window.beforeunload=null}},{key:"handleMuteButtons",value:function(e){var _this6=this,button=e.target.closest('a[data-action="mute"], a[data-action="unmute"]');if(button){var action=button.getAttribute("data-action"),peerid=button.closest("[data-peerid]").getAttribute("data-peerid");e.stopPropagation(),e.preventDefault(),button.closest("#deft_audio")?_ajax.default.call([{args:{mute:!0,peerid:peerid,status:!1},fail:_notification.default.exception,methodname:"block_deft_venue_settings"}]):this.audioInput.then((function(audioStream){return audioStream?_ajax.default.call([{args:{mute:"mute"==action,status:!1},fail:_notification.default.exception,methodname:"block_deft_venue_settings"}]):"unmute"==action&&(_this6.audioInput=navigator.mediaDevices.getUserMedia({audio:{autoGainControl:_this6.autogaincontrol,echoCancellation:_this6.echocancellation,noiseSuppression:_this6.noisesuppression,sampleRate:_this6.samplerate},video:!1}).then((function(audioStream){return _ajax.default.call([{args:{mute:!1,status:!1},fail:_notification.default.exception,methodname:"block_deft_venue_settings"}]),_this6.monitorVolume(audioStream),audioStream})).catch(_log.default.debug)),audioStream})).catch(_notification.default.exception),button.closest("[data-peerid]").querySelectorAll('[data-action="mute"], [data-action="unmute"]').forEach((function(option){option.getAttribute("data-action")==action?option.classList.add("hidden"):option.classList.remove("hidden")}))}}},{key:"handleRaiseHand",value:function(e){var button=e.target.closest('[data-action="raisehand"], [data-action="lowerhand"]');if(button&&!button.closest("#deft_audio")){var action=button.getAttribute("data-action");e.stopPropagation(),e.preventDefault(),"raisehand"==action?document.querySelector("body").classList.add("block_deft_raisehand"):document.querySelector("body").classList.remove("block_deft_raisehand"),document.querySelectorAll('a[data-action="raisehand"], a[data-action="lowerhand"]').forEach((function(button){button.getAttribute("data-action")==action?button.classList.add("hidden"):button.classList.remove("hidden")})),_ajax.default.call([{args:{status:"raisehand"==action},fail:_notification.default.exception,methodname:"block_deft_raise_hand"}]),this.dataChannels.forEach((function(dataChannel){"open"==dataChannel.readyState&&("raisehand"==action?dataChannel.send('{"raisehand": true}'):dataChannel.send('{"raisehand": false}'))}))}}},{key:"monitorVolume",value:function(audioStream){var _this7=this;if(audioStream){var audioContext=new AudioContext,source=audioContext.createMediaStreamSource(audioStream),analyser=new AnalyserNode(audioContext,{maxDecibels:-50,minDecibels:-90,fftSize:2048,smoothingTimeConstant:.3}),bufferLength=analyser.frequencyBinCount,data=new Uint8Array(bufferLength);source.connect(analyser),clearInterval(this.meterId),this.meterId=setInterval((function(){analyser.getByteFrequencyData(data);var volume={low:Math.min(1,data.slice(0,16).reduce((function(a,b){return a+b}),0)/2e3),mid:Math.min(1,data.slice(17,31).reduce((function(a,b){return a+b}),0)/1e3),high:Math.min(1,data.slice(32).reduce((function(a,b){return a+b}),0)/4e3)},message=JSON.stringify({volume:volume}),peers=[];document.querySelectorAll('.volume_indicator[data-peerid="'+_this7.peerid+'"]').forEach((function(indicator){indicator.querySelectorAll(".low").forEach((function(low){low.style.opacity=volume.low})),indicator.querySelectorAll(".mid").forEach((function(mid){mid.style.opacity=volume.mid})),indicator.querySelectorAll(".high").forEach((function(high){high.style.opacity=volume.high}))})),_this7.dataChannels.forEach((function(dataChannel){"open"==dataChannel.readyState&&dataChannel.send(message)})),document.querySelectorAll("#deft_audio > div").forEach((function(peer){peers.push(peer)})),peers.sort((function(a,b){var volume=0;return a.querySelectorAll(".high, .mid, .low").forEach((function(indicator){volume+=-indicator.style.opacity})),b.querySelectorAll(".high, .mid, .low").forEach((function(indicator){volume+=indicator.style.opacity})),volume})),peers.forEach((function(peer){document.querySelector("#deft_audio").appendChild(peer)}))}),500)}return audioStream}},{key:"peerAudioPlayer",value:function(peerid){var usernode=document.querySelector('#deft_audio div[data-peerid="'+peerid+'"] audio');if(usernode)return Promise.resolve(usernode);var node=document.createElement("div");return node.setAttribute("data-peerid",peerid),document.querySelector("body#page-blocks-deft-venue")?node.setAttribute("class","col col-12 col-md-6 col-lg-4 col-xl-3 m-2"):node.setAttribute("class","col col-12 m-2"),window.setTimeout((function(){node.querySelectorAll("img.card-img-top").forEach((function(image){image.setAttribute("height",null),image.setAttribute("width",null)}))})),_fragment.default.loadFragment("block_deft","venue",this.contextid,{peerid:peerid}).done((function(userinfo){document.querySelector('#deft_audio div[data-peerid="'+peerid+'"] audio')||(document.querySelector("#deft_audio").appendChild(node),node.innerHTML=userinfo)})).then((function(){return document.querySelector('#deft_audio div[data-peerid="'+peerid+'"] audio')})).catch(_notification.default.exception)}}])&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),_default}();return _exports.default=_default,_exports.default}));

//# sourceMappingURL=venue_manager.min.js.map