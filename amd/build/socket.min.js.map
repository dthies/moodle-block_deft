{"version":3,"file":"socket.min.js","sources":["../src/socket.js"],"sourcesContent":["/*\n * Open and maintain a WebSocket to recieve messages from server.\n *\n * @package    block_deft\n * @module     block_deft/socket\n * @copyright  2022 Daniel Thies <dethies@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Ajax from \"core/ajax\";\nimport Log from \"core/log\";\nimport Notification from \"core/notification\";\n\n\nexport class Socket {\n    /**\n     * Listen to WebSocket and refresh content\n     *\n     * @param {int} contextid Context id of block\n     * @param {string} token Authentication token to connect service\n     */\n    constructor(contextid, token) {\n        this.listeners = [];\n        this.connect(contextid, token);\n    }\n\n    /**\n     * Connect to service\n     *\n     * @param {int} contextid Context id of block\n     * @param {string} token Authentication token to connect service\n     * @returns {object}\n     * @chainable\n     */\n    connect(contextid, token) {\n        this.websocket = new WebSocket('wss://deftly.us/ws');\n        this.websocket.onopen = (e) => {\n            this.websocket.send(token);\n            this.listeners.forEach((callback) => {\n                this.websocket.addEventListener('message', callback);\n                callback.apply(this, [e]);\n            });\n        };\n\n        this.websocket.addEventListener('close', (e) => {\n            Log.debug('Disconnected');\n            if (this.disconnected) {\n                return this;\n            } else if (e.code == 1011) {\n                Log.debug('Authentication failed');\n                this.renewToken(contextid);\n            } else {\n                setTimeout(() => {\n                    Log.debug('Reconnecting');\n                    this.connect(contextid, token);\n                }, 5000);\n            }\n\n            return true;\n        });\n\n        return this;\n    }\n\n    /**\n     * Disconnect socket\n     *\n     * @returns {object}\n     * @chainable\n     */\n    disconnect() {\n        this.disconnected = true;\n        this.websocket.close();\n\n        return this;\n    }\n\n    /**\n     * Subscribe listener\n     *\n     * @param {function} callback\n     * @returns {object}\n     * @chainable\n     */\n    subscribe(callback) {\n        this.websocket.addEventListener('message', callback);\n        this.listeners.push(callback);\n\n        return this;\n    }\n\n    /**\n     * Renew token\n     *\n     * @param {int} contextid Context id of block\n     */\n    renewToken(contextid) {\n        Ajax.call([{\n            methodname: 'block_deft_renew_token',\n            args: {contextid: contextid},\n            done: (replacement) => {\n                Log.debug('Reconnecting');\n                this.connect(contextid, replacement.token);\n            },\n            fail: Notification.exception\n        }]);\n    }\n}\n\nexport default Socket;\n"],"names":["_interopRequireDefault","e","__esModule","default","_ajax","_log","_notification","Socket","constructor","contextid","token","this","listeners","connect","websocket","WebSocket","onopen","send","forEach","callback","addEventListener","apply","Log","debug","disconnected","code","renewToken","setTimeout","disconnect","close","subscribe","push","Ajax","call","methodname","args","done","replacement","fail","Notification","exception","_exports","_default"],"mappings":"8HAW6C,SAAAA,uBAAAC,GAAAA,OAAAA,GAAAA,EAAAC,WAAAD,EAAAE,CAAAA,QAAAF,EAAA;;;;;;;;qGAF7CG,MAAAJ,uBAAAI,OACAC,KAAAL,uBAAAK,MACAC,cAAAN,uBAAAM,eAGO,MAAMC,OAOTC,WAAAA,CAAYC,UAAWC,OACnBC,KAAKC,UAAY,GACjBD,KAAKE,QAAQJ,UAAWC,MAC5B,CAUAG,OAAAA,CAAQJ,UAAWC,OA2Bf,OA1BAC,KAAKG,UAAY,IAAIC,UAAU,sBAC/BJ,KAAKG,UAAUE,OAAUf,IACrBU,KAAKG,UAAUG,KAAKP,OACpBC,KAAKC,UAAUM,QAASC,WACpBR,KAAKG,UAAUM,iBAAiB,UAAWD,UAC3CA,SAASE,MAAMV,KAAM,CAACV,OAI9BU,KAAKG,UAAUM,iBAAiB,QAAUnB,IACtCqB,KAAAA,QAAIC,MAAM,gBACNZ,KAAKa,aACEb,MACU,MAAVV,EAAEwB,MACTH,KAAAA,QAAIC,MAAM,yBACVZ,KAAKe,WAAWjB,YAEhBkB,WAAW,KACPL,KAAAA,QAAIC,MAAM,gBACVZ,KAAKE,QAAQJ,UAAWC,QACzB,MAGA,KAGJC,IACX,CAQAiB,UAAAA,GAII,OAHAjB,KAAKa,cAAe,EACpBb,KAAKG,UAAUe,QAERlB,IACX,CASAmB,SAAAA,CAAUX,UAIN,OAHAR,KAAKG,UAAUM,iBAAiB,UAAWD,UAC3CR,KAAKC,UAAUmB,KAAKZ,UAEbR,IACX,CAOAe,UAAAA,CAAWjB,WACPuB,MAAI7B,QAAC8B,KAAK,CAAC,CACPC,WAAY,yBACZC,KAAM,CAAC1B,UAAWA,WAClB2B,KAAOC,cACHf,KAAAA,QAAIC,MAAM,gBACVZ,KAAKE,QAAQJ,UAAW4B,YAAY3B,QAExC4B,KAAMC,sBAAaC,YAE3B,EACHC,SAAAlC,OAAAA,OAAA,IAAAmC,SAEcnC,OAAM,OAAAkC,SAAAtC,QAAAuC,SAAAD,SAAAtC,OAAA"}