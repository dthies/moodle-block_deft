{"version":3,"file":"refresh.min.js","sources":["../src/refresh.js"],"sourcesContent":["/*\n * Refresh content when changed on the system\n *\n * @package    block_deft\n * @module     block_deft/refresh\n * @copyright  2022 Daniel Thies <dethies@gmail.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Fragment from \"core/fragment\";\nimport Log from \"core/log\";\nimport Socket from \"block_deft/socket\";\nimport Templates from \"core/templates\";\n\nexport default class {\n\n    /**\n     * Listen to WebSocket and refresh content\n     *\n     * @param {int} contextid Context id of block\n     * @param {string} selector Content location to replace\n     * @param {string} token Authentication token to connect service\n     * @param {int} throttle Throttle dely in ms\n     */\n    constructor(contextid, selector, token, throttle) {\n        if (!token) {\n            return;\n        }\n\n        const socket = new Socket(contextid, token);\n\n        socket.subscribe(() => {\n            this.update();\n        });\n\n        this.contextid = contextid;\n        this.selector = selector;\n        this.throttle = throttle;\n        this.throttled = false;\n        this.lastupdate = 0;\n    }\n\n    /**\n     * Refresh content\n     *\n     */\n    update() {\n        if (document.querySelector(this.selector)) {\n            let content = document.querySelector(this.selector).parentNode,\n                component = content.closest('[data-component]')\n                    && content.closest('[data-component]').getAttribute('data-component')\n                    || 'block_deft',\n                data = {};\n            if (!content) {\n                return;\n            }\n\n            if (\n                (this.lastupdate + this.throttle > Date.now())\n                || (document.activeElement.closest(this.selector) && document.activeElement.closest('select'))\n            ) {\n                if (\n                    !this.throttled\n                    || (this.lastupdate + this.throttle < Date.now())\n                ) {\n                    setTimeout(() => {\n                        this.update();\n                    }, Math.max(this.lastupdate + this.throttle - Date.now(), 40));\n                    this.throttled = true;\n                }\n\n                return;\n            }\n\n            document.querySelector(this.selector)\n                .querySelectorAll('[data-type=\"comments\"] .block_deft_comments.expanded')\n                .forEach((opencomments) => {\n                    data.opencomments = data.opencomments || [];\n                    data.opencomments.push(opencomments.closest('[data-task]').getAttribute('data-task'));\n                });\n\n            if (document.querySelector(this.selector).closest('[data-modified]')) {\n                data.lastmodified = document.querySelector(this.selector).closest('[data-modified]').getAttribute('data-modified');\n            }\n\n            Fragment.loadFragment(\n                component,\n                'content',\n                this.contextid,\n                {\n                    jsondata: JSON.stringify(data)\n                }\n            ).done((html, js) => {\n                if (html) {\n                    this.replace(content, html, js);\n                }\n            }).catch(Log.debug);\n\n            this.throttled = false;\n            this.lastupdate = Date.now();\n        }\n    }\n\n    /**\n     * Replace content\n     *\n     * @param {DOMNode} content\n     * @param {string} html New content\n     * @param {string} js Scripts to run after replacement\n     */\n    replace(content, html, js) {\n        let setScroll = () => {\n                return true;\n            },\n            setHeight = () => {\n                return true;\n            };\n        content.style.height = content.offsetHeight;\n        setTimeout(() => {\n            content.style.height = null;\n        });\n        content.querySelectorAll('.block_deft_comments').forEach((comments) => {\n            const position = comments.scrollTop,\n                task = comments.closest('[data-task]').getAttribute('data-task'),\n                recurse = setScroll;\n            setScroll = () => {\n                content.querySelectorAll('[data-task=\"' + task + '\"]').forEach((task) => {\n                    task.querySelector('.block_deft_comments').scrollTop = position;\n                });\n                recurse();\n            };\n        });\n\n        content.querySelectorAll('[data-summary]').forEach((summary) => {\n            const height = summary.offsetHeight,\n                task = summary.getAttribute('data-summary'),\n                recurse = setHeight;\n            setHeight = () => {\n                content.querySelectorAll('[data-summary=\"' + task + '\"]').forEach((summary) => {\n                    summary.setAttribute('style', 'min-height: ' + height + 'px;');\n                });\n                recurse();\n            };\n        });\n        Templates.replaceNodeContents(content, html, js);\n        setScroll();\n        setHeight();\n    }\n}\n"],"names":["_interopRequireDefault","e","__esModule","default","_fragment","_log","_socket","_templates","_exports","constructor","contextid","selector","token","throttle","Socket","subscribe","this","update","throttled","lastupdate","document","querySelector","content","parentNode","component","closest","getAttribute","data","Date","now","activeElement","setTimeout","Math","max","querySelectorAll","forEach","opencomments","push","lastmodified","Fragment","loadFragment","jsondata","JSON","stringify","done","html","js","replace","catch","Log","debug","setScroll","setHeight","style","height","offsetHeight","comments","position","scrollTop","task","recurse","summary","setAttribute","Templates","replaceNodeContents"],"mappings":"6JAYuC,SAAAA,uBAAAC,GAAAA,OAAAA,GAAAA,EAAAC,WAAAD,EAAAE,CAAAA,QAAAF,EAAA;;;;;;;;qFAHvCG,UAAAJ,uBAAAI,WACAC,KAAAL,uBAAAK,MACAC,QAAAN,uBAAAM,SACAC,WAAAP,uBAAAO,YAwIC,OAAAC,SAAAL,QAtIc,MAUXM,WAAAA,CAAYC,UAAWC,SAAUC,MAAOC,UACpC,IAAKD,MACD,OAGW,IAAIE,QAAAA,QAAOJ,UAAWE,OAE9BG,UAAU,KACbC,KAAKC,WAGTD,KAAKN,UAAYA,UACjBM,KAAKL,SAAWA,SAChBK,KAAKH,SAAWA,SAChBG,KAAKE,WAAY,EACjBF,KAAKG,WAAa,CACtB,CAMAF,MAAAA,GACI,GAAIG,SAASC,cAAcL,KAAKL,UAAW,CACvC,IAAIW,QAAUF,SAASC,cAAcL,KAAKL,UAAUY,WAChDC,UAAYF,QAAQG,QAAQ,qBACrBH,QAAQG,QAAQ,oBAAoBC,aAAa,mBACjD,aACPC,KAAO,CAAA,EACX,IAAKL,QACD,OAGJ,GACKN,KAAKG,WAAaH,KAAKH,SAAWe,KAAKC,OACpCT,SAASU,cAAcL,QAAQT,KAAKL,WAAaS,SAASU,cAAcL,QAAQ,UAYpF,cATKT,KAAKE,WACFF,KAAKG,WAAaH,KAAKH,SAAWe,KAAKC,SAE3CE,WAAW,KACPf,KAAKC,UACNe,KAAKC,IAAIjB,KAAKG,WAAaH,KAAKH,SAAWe,KAAKC,MAAO,KAC1Db,KAAKE,WAAY,IAMzBE,SAASC,cAAcL,KAAKL,UACvBuB,iBAAiB,wDACjBC,QAASC,eACNT,KAAKS,aAAeT,KAAKS,cAAgB,GACzCT,KAAKS,aAAaC,KAAKD,aAAaX,QAAQ,eAAeC,aAAa,gBAG5EN,SAASC,cAAcL,KAAKL,UAAUc,QAAQ,qBAC9CE,KAAKW,aAAelB,SAASC,cAAcL,KAAKL,UAAUc,QAAQ,mBAAmBC,aAAa,kBAGtGa,UAAQpC,QAACqC,aACLhB,UACA,UACAR,KAAKN,UACL,CACI+B,SAAUC,KAAKC,UAAUhB,QAE/BiB,KAAK,CAACC,KAAMC,MACND,MACA7B,KAAK+B,QAAQzB,QAASuB,KAAMC,MAEjCE,MAAMC,KAAG9C,QAAC+C,OAEblC,KAAKE,WAAY,EACjBF,KAAKG,WAAaS,KAAKC,KAC3B,CACJ,CASAkB,OAAAA,CAAQzB,QAASuB,KAAMC,IACnB,IAAIK,UAAYA,KACD,EAEXC,UAAYA,KACD,EAEf9B,QAAQ+B,MAAMC,OAAShC,QAAQiC,aAC/BxB,WAAW,KACPT,QAAQ+B,MAAMC,OAAS,OAE3BhC,QAAQY,iBAAiB,wBAAwBC,QAASqB,WACtD,MAAMC,SAAWD,SAASE,UACtBC,KAAOH,SAAS/B,QAAQ,eAAeC,aAAa,aACpDkC,QAAUT,UACdA,UAAYA,KACR7B,QAAQY,iBAAiB,eAAiByB,KAAO,MAAMxB,QAASwB,OAC5DA,KAAKtC,cAAc,wBAAwBqC,UAAYD,WAE3DG,aAIRtC,QAAQY,iBAAiB,kBAAkBC,QAAS0B,UAChD,MAAMP,OAASO,QAAQN,aACnBI,KAAOE,QAAQnC,aAAa,gBAC5BkC,QAAUR,UACdA,UAAYA,KACR9B,QAAQY,iBAAiB,kBAAoByB,KAAO,MAAMxB,QAAS0B,UAC/DA,QAAQC,aAAa,QAAS,eAAiBR,OAAS,SAE5DM,aAGRG,WAAS5D,QAAC6D,oBAAoB1C,QAASuB,KAAMC,IAC7CK,YACAC,WACJ,GACH5C,SAAAL,OAAA"}