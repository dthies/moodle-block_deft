{"version":3,"file":"venue_manager.min.js","sources":["../../src/jitsi/venue_manager.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/ //\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/*\n * Deft response Jitsi integration venue manager\n *\n * @package    block_deft\n * @module     block_deft/jitsi/venue_manager\n * @copyright  2025 Daniel Thies\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\nvar domain;\nvar connection;\n\nimport Ajax from \"core/ajax\";\nimport Fragment from 'core/fragment';\nimport JitsiMeetJS from \"block_deft/jitsi/lib-jitsi-meet.min\";\nimport Log from \"core/log\";\nimport Notification from \"core/notification\";\nimport Socket from \"block_deft/jitsi/socket\";\nimport Templates from \"core/templates\";\nimport VenueManager from \"block_deft/venue_manager\";\n\nexport default class MediaManager extends VenueManager {\n    /**\n     * Initialize player plugin\n     *\n     * @param {int} contextid\n     * @param {string} server Jitsi server to use\n     * @param {string} room Room name\n     * @param {object} userinfo User information to pass to meeting\n     * @param {string} jwt JWT authentication token\n     * @param {int} peerid Peer ID\n     *\n     * @returns {bool}\n     */\n    constructor(contextid, server, room, userinfo, jwt, peerid) {\n\n        super(contextid, '', [], '', true, true, 14400, 0, '');\n        this.contextid = contextid;\n        domain = server;\n        this.userinfo = [];\n        this.peerid = peerid;\n        this.displayedTracks = [];\n        this.videoTracks = {};\n        this.audioTracks = {};\n\n        JitsiMeetJS.init();\n        JitsiMeetJS.setLogLevel(JitsiMeetJS.logLevels.DEBUG);\n        if (connection) {\n            connection.disconnect();\n        }\n\n        connection = new JitsiMeetJS.JitsiConnection(null, jwt, {\n            serviceUrl: `https://${ domain }/http-bind`,\n            hosts: {\n                domain: domain,\n                muc: `conference.${ domain }`\n            }\n        });\n        connection.addEventListener(JitsiMeetJS.events.connection.CONNECTION_ESTABLISHED, () => {\n            this.room = connection.initJitsiConference(room, {\n                disableSimulcast: true\n            });\n            this.room.addEventListener(JitsiMeetJS.events.conference.TRACK_ADDED, track => {\n                this.onRemoteTrack(track);\n            });\n            this.room.addEventListener(JitsiMeetJS.events.conference.TRACK_REMOVED, track => {\n                if (track.getType() == 'video') {\n                    this.videoTracks[track.getParticipantId()] = null;\n                } else {\n                    this.audioTracks[track.getParticipantId()] = null;\n                }\n                track.dispose();\n            });\n            this.room.addCommandListener('updateinterface', e => {\n                this.handleMessage(e.attributes.id, {\n                    data: e.attributes.message\n                });\n            });\n\n            this.socket = new Socket(this.room);\n            this.socket.subscribe(() => {\n                this.sendSignals();\n            });\n            this.room.on(JitsiMeetJS.events.conference.CONFERENCE_JOINED, async() => {\n                const tracks = await JitsiMeetJS.createLocalTracks({\n                    devices: ['audio'],\n                });\n                tracks.forEach(track => {\n                    if (this[`${ track.getType() }Track`]) {\n                        this.room.replaceTrack(this[`${ track.getType() }Track`], track);\n                    } else {\n                        this.room.addTrack(track);\n                    }\n                    this[`${ track.getType() }Track`] = track;\n\n                    this.monitorVolume(track.stream);\n                });\n                this.register();\n            });\n\n            document.body.addEventListener(\n                'venueclosed',\n                () => {\n                    this.closeConnections();\n                }\n            );\n\n            this.room.join();\n\n            document.body.addEventListener('click', e => this.handleClick(e));\n        });\n        connection.addEventListener(JitsiMeetJS.events.connection.CONNECTION_DISCONNECTED, () => {\n            window.close();\n        });\n\n        connection.connect();\n\n        this.addListeners();\n\n        return true;\n    }\n\n    /**\n     * Start to establish the peer connections\n     */\n    startConnection() {\n    }\n\n    /**\n     * Update motions\n     *\n     * @param {int} contextid\n     */\n    async updateMotions(contextid) {\n        const selector = `[data-contextid=\"${contextid}\"][data-region=\"plenum-motions\"]`;\n        const content = document.querySelector(selector);\n        if (content) {\n            const response = await Ajax.call([{\n                args: {\n                    contextid: contextid\n                },\n                contextid: contextid,\n                fail: Notification.exception,\n                methodname: 'plenumform_jitsi2_update_content'\n            }])[0];\n            if (response.motions) {\n                Templates.replaceNodeContents(content, response.motions, response.javascript);\n                this.userinfo = response.userinfo;\n                this.updateMedia();\n            }\n            if (response.controls) {\n                const selector = `[data-contextid=\"${contextid}\"][data-region=\"plenum-deft-controls\"]`;\n                Templates.replaceNodeContents(selector, response.controls, '');\n            }\n            if (!response.sharevideo) {\n                this.room.getLocalTracks().forEach(track => {\n                    track.dispose();\n                });\n            }\n        }\n    }\n\n    /**\n     * Attach or detach media\n     */\n    updateMedia() {\n        return;\n        this.displayedTracks.forEach(async track => {\n            if (!this.userinfo.find(speaker => speaker.id == track.getParticipantId())) {\n                document.querySelectorAll(\n                    `[data-region=\"slot-${ track.role }\"] ${ track.getType() }`\n                ).forEach(player => {\n                    track.detach(player);\n                });\n                delete this.displayedTracks[this.displayedTracks.indexOf(track)];\n            }\n        });\n        this.userinfo.forEach(speaker => {\n            if (this.videoTracks[speaker.id]) {\n                const track = this.videoTracks[speaker.id];\n                if (!this.displayedTracks.includes(track)) {\n                    track.role = speaker.role;\n                    track.attach(document.querySelector(`[data-region=\"slot-${ speaker.role }\"] ${ track.getType() }`));\n                    this.displayedTracks.push(track);\n                }\n            }\n            if (this.audioTracks[speaker.id]) {\n                const track = this.audioTracks[speaker.id];\n                if (!this.displayedTracks.includes(track)) {\n                    track.role = speaker.role;\n                    track.attach(document.querySelector(`[data-region=\"slot-${ speaker.role }\"] ${ track.getType() }`));\n                    this.displayedTracks.push(track);\n                }\n            }\n            document.querySelectorAll(`[data-region=\"slot-${ speaker.role }\"] .card-header`).forEach(function(h) {\n                h.innerHTML = speaker.name;\n            });\n            document.querySelectorAll(`[data-region=\"slot-${ speaker.role }\"] video`).forEach(function(video) {\n                video.poster = speaker.pictureurl;\n            });\n        });\n    }\n\n    /**\n     * Process new remote track\n     *\n     * @param {JitsiTrack} track New track\n     */\n    onRemoteTrack(track) {\n        Log.debug(track);\n        if (track.getType() == 'video') {\n            this.videoTracks[track.getParticipantId()] = track;\n        } else {\n            this.audioTracks[track.getParticipantId()] = track;\n        }\n        this.updateMedia();\n    }\n\n    /**\n     * Change published media in activity\n     *\n     * @param {bool} publish Whether to add or remove media\n     */\n    async publish(publish) {\n        await Ajax.call([{\n            args: {\n                //id: this.room.myUserId(),\n                id: this.peerid,\n                publish: publish,\n                room: 0\n            },\n            contextid: this.contextid,\n            fail: Notification.exception,\n            methodname: 'block_deft_publish_feed'\n        }])[0];\n        this.socket.notify();\n    }\n\n    /**\n     * Register the room\n     *\n     * @return {Promise}\n     */\n    async register() {\n        // Try a registration\n        const response = await Ajax.call([{\n            args: {\n                handle: 0,\n                id: Number(this.peerid),\n                //plugin: pluginHandle.plugin,\n                plugin: this.room.myUserId(),\n                room: 0,\n                session: 0,\n            },\n            contextid: this.contextid,\n            fail: Notification.exception,\n            methodname: 'block_deft_join_room'\n        }])[0];\n\n        if (response.status) {\n        }\n            this.socket.notify();\n\n        return response;\n    }\n\n    /**\n     * Handle button click\n     *\n     * @param {Event} e Click event\n     */\n    async handleClick(e) {\n        const button = e.target.closest('a[data-action=\"publish\"], a[data-action=\"unpublish\"]');\n\n        if (!button) {\n            return;\n        }\n        e.stopPropagation();\n        e.preventDefault();\n\n        if (button.dataset.action == 'publish') {\n            if (!this.audioTrack) {\n                return;\n            }\n            const tracks = await JitsiMeetJS.createLocalTracks({\n                devices: ['video'],\n                constraints: {aspectRatio: {exact: 1}, height: {ideal: 360}, width: {ideal: 360}}\n            });\n            tracks.forEach(track => {\n                if (this[`${ track.getType() }Track`]) {\n                    this.room.replaceTrack(this[`${ track.getType() }Track`], track);\n                } else {\n                    this.room.addTrack(track);\n                }\n                this[`${ track.getType() }Track`] = track;\n            });\n            this.publish(true);\n            document.querySelectorAll('a[data-action=\"publish\"]').forEach(button => {\n                button.classList.add('hidden');\n            });\n            document.querySelectorAll('a[data-action=\"unpublish\"]').forEach(button => {\n                button.classList.remove('hidden');\n            });\n        } else {\n            document.querySelectorAll('a[data-action=\"publish\"]').forEach(button => {\n                button.classList.remove('hidden');\n            });\n            document.querySelectorAll('a[data-action=\"unpublish\"]').forEach(button => {\n                button.classList.add('hidden');\n            });\n            if (this.videoTrack) {\n                this.videoTrack.dispose();\n                this.videoTrack = null;\n            }\n            this.publish(false);\n        }\n    }\n\n    /**\n     * Change mute status\n     *\n     * @param {bool} state State to be set\n     */\n    mute(state) {\n        if (this.audioTrack) {\n            this.audioTrack.track.enabled = !state;\n        }\n    }\n\n    processSignal() {\n        return;\n    }\n\n    /**\n     * Transfer signals with signal server\n     */\n    sendSignals() {\n\n        if (this.throttled || !navigator.onLine) {\n            return;\n        }\n\n        const time = Date.now();\n        if (this.lastUpdate + 200 > time) {\n            this.throttled = true;\n            setTimeout(() => {\n                this.throttled = false;\n            }, this.lastUpdate + 250 - time);\n            this.sendSignals();\n            return;\n        }\n        this.lastUpdate = time;\n\n        Ajax.call([{\n            args: {\n                contextid: this.contextid,\n                lastsignal: 0,\n                messages: [],\n            },\n            contextid: this.contextid,\n            done: response => {\n                this.subscribeTo(response.feed);\n                response.settings.forEach(peer => {\n                    if (peer.id == Number(this.peerid)) {\n                        if (peer.status) {\n                            // Release microphone.\n                            clearInterval(this.meterId);\n                            if (this.audioTrack) {\n                                this.audioTrack.track.stop();\n                            }\n                            // Close connections.\n                            document.querySelectorAll(\n                                '[data-region=\"deft-venue\"] [data-peerid=\"' + this.peerid\n                                + '\"], [data-region=\"deft-venue\"] [data-action=\"publish\"]'\n                            ).forEach(venue => {\n                                const e = new Event('venueclosed', {bubbles: true});\n                                venue.dispatchEvent(e);\n                            });\n\n                            this.socket.disconnect();\n\n                            this.closeConnections();\n\n                            return;\n                        }\n                        this.mute(peer.mute);\n                    }\n                    document.querySelectorAll(\n                        '[data-peerid=\"' + peer.id + '\"] [data-action=\"mute\"], [data-peerid=\"' + peer.id\n                            + '\"] [data-action=\"unmute\"]'\n                    ).forEach(button => {\n                        if (peer.mute == (button.getAttribute('data-action') == 'mute')) {\n                            button.classList.add('hidden');\n                        } else {\n                            button.classList.remove('hidden');\n                        }\n                    });\n                    if (\n                        !response.peers.includes(Number(peer.id))\n                        && document.querySelector('#deft_audio [data-peerid=\"' + peer.id + '\"]')\n                    ) {\n                        document.querySelector('#deft_audio [data-peerid=\"' + peer.id + '\"]').remove();\n                    }\n                    if (!document.querySelector('#deft_audio [data-peerid=\"' + peer.id + '\"]')\n                        && this.audioTracks[peer.username]\n                        && peer.id != this.peerid\n                    ) {\n                        this.peerAudioPlayer(peer);\n                    }\n                });\n                if (!response.peers.includes(Number(this.peerid))) {\n                    return;\n                }\n                if (response.peers.includes(Number(response.feed))) {\n                } else {\n                }\n            },\n            fail: Notification.exception,\n            methodname: 'block_deft_send_signal'\n        }]);\n    }\n\n    /**\n     * Send a message through data channel to peers\n     *\n     * @param {string} text\n     */\n    sendMessage(text) {\n        if (text) {\n            this.room.sendCommandOnce('updateinterface', {\n                value: 'updateinterface',\n                attributes: {\n                    id: this.peerid,\n                    message: text\n                },\n                children: []\n            });\n        }\n    }\n\n    /**\n     * Return audio player for peer\n     *\n     * @param {object} peer Peer information\n     * @returns {Promise} Resolve to audio player node\n     */\n    peerAudioPlayer(peer) {\n        const usernode = document.querySelector('#deft_audio div[data-peerid=\"' + peer.id + '\"] audio');\n        if (usernode) {\n            return Promise.resolve(usernode);\n        } else {\n            const node = document.createElement('div');\n            node.setAttribute('data-peerid', peer.id);\n            if (document.querySelector('body#page-blocks-deft-venue')) {\n                node.setAttribute('class', 'col col-12 col-sm-6 col-md-4 col-lg-3 p-2');\n            } else {\n                node.setAttribute('class', 'col col-12 col-sm-6 col-md-4 p-2');\n            }\n            window.setTimeout(() => {\n                node.querySelectorAll('img.card-img-top').forEach(image => {\n                    image.setAttribute('height', null);\n                    image.setAttribute('width', null);\n                });\n            });\n            return Fragment.loadFragment(\n                'block_deft',\n                'venue',\n                this.contextid,\n                {\n                    peerid: peer.id\n                }\n            ).done((userinfo) => {\n                if (!document.querySelector('#deft_audio div[data-peerid=\"' + peer.id + '\"] audio')) {\n                    document.querySelector('#deft_audio').appendChild(node);\n                    node.innerHTML = userinfo;\n                }\n            }).then(() => {\n                const audio = document.querySelector('#deft_audio div[data-peerid=\"' + peer.id + '\"] audio');\n                if (audio) {\n                    const track = this.audioTracks[peer.username];\n                    track.attach(audio);\n                }\n                return audio;\n            }).catch(Notification.exception);\n        }\n    }\n\n    /**\n     * Add event listeners\n     */\n    addListeners() {\n\n        document.querySelector('body').removeEventListener('click', this.handleMuteButtons.bind(this));\n        document.querySelector('body').addEventListener('click', this.handleMuteButtons.bind(this));\n\n        document.querySelector('body').removeEventListener('click', this.handleRaiseHand.bind(this));\n        document.querySelector('body').addEventListener('click', this.handleRaiseHand.bind(this));\n\n        document.querySelector('body').removeEventListener('click', this.closeConnections.bind(this));\n        document.querySelector('body').addEventListener('click', this.closeConnections.bind(this));\n\n        window.onbeforeunload = this.closeConnections.bind(this);\n    }\n\n    /**\n     * Handle click for mute\n     *\n     * @param {Event} e Button click\n     */\n    async handleMuteButtons(e) {\n        const button = e.target.closest(\n            'a[data-action=\"mute\"], a[data-action=\"unmute\"]'\n        );\n        if (button) {\n            const action = button.getAttribute('data-action'),\n                peerid = button.closest('[data-peerid]').getAttribute('data-peerid');\n            e.stopPropagation();\n            e.preventDefault();\n            if (peerid == this.peerid) {\n                this.mute(action == 'mute');\n            }\n            await Ajax.call([{\n                args: {\n                    mute: action == 'mute',\n                    peerid: peerid,\n                    \"status\": false\n                },\n                fail: Notification.exception,\n                methodname: 'block_deft_venue_settings'\n            }]);\n            button.closest('[data-peerid]').querySelectorAll('[data-action=\"mute\"], [data-action=\"unmute\"]').forEach(option => {\n                if (option.getAttribute('data-action') == action) {\n                    option.classList.add('hidden');\n                } else {\n                    option.classList.remove('hidden');\n                }\n            });\n            this.socket.notify();\n        }\n    }\n\n    /**\n     * Shut down gracefully before closing\n     *\n     * @param {Event} e Button click\n     */\n    async closeConnections(e) {\n        if (e && e.type == 'click') {\n            const button = e.target.closest('[data-region=\"deft-venue\"] a[data-action=\"close\"]');\n            if (button) {\n                e.stopPropagation();\n                e.preventDefault();\n            } else {\n                return;\n            }\n        }\n        document.querySelectorAll('[data-region=\"deft-venue\"] a[data-action=\"close\"] i').forEach(button => {\n            button.classList.add('bg-danger');\n        });\n        if (this.room) {\n            this.room.getLocalTracks().forEach(track => {\n                track.dispose();\n            });\n        }\n        document.querySelector('body').classList.remove('block_deft_raisehand');\n        await Ajax.call([{\n            args: {\n                mute: false,\n                \"status\": true\n            },\n            fail: Notification.exception,\n            methodname: 'block_deft_venue_settings'\n        }]);\n\n        // Release microphone.\n        clearInterval(this.meterId);\n\n        // Close connections.\n        connection.disconnect();\n\n        document.querySelectorAll('[data-region=\"deft-venue\"] [data-peerid=\"' + this.peerid + '\"]').forEach(venue => {\n            const event = new Event('venueclosed');\n            venue.dispatchEvent(event);\n        });\n\n        window.beforeunload = null;\n\n        this.sendSignals();\n    }\n\n    /**\n     * Subscribe to feed\n     *\n     * @param {int} source Feed to subscribe\n     */\n    subscribeTo(source) {\n        Log.debug(source);\n        if (!source || !this.videoTracks[source]) {\n            document.querySelectorAll('[data-region=\"deft-venue\"] video').forEach(video => {\n                video.classList.add('hidden');\n            });\n            Log.debug('no source');\n            this.currentFeed = null;\n\n            return;\n        }\n\n        if (this.currentFeed == source) {\n            Log.debug('no change');\n            return;\n        }\n        Log.debug(this.currentFeed);\n        this.currentFeed = source;\n\n        const track = this.videoTracks[source];\n        document.querySelectorAll('[data-region=\"deft-venue\"] video').forEach(video => {\n            track.attach(video);\n            video.classList.remove('hidden');\n        });\n    }\n}\n"],"names":["domain","connection","MediaManager","VenueManager","constructor","contextid","server","room","userinfo","jwt","peerid","displayedTracks","videoTracks","audioTracks","init","setLogLevel","JitsiMeetJS","logLevels","DEBUG","disconnect","JitsiConnection","serviceUrl","hosts","muc","addEventListener","events","CONNECTION_ESTABLISHED","initJitsiConference","disableSimulcast","conference","TRACK_ADDED","track","onRemoteTrack","TRACK_REMOVED","getType","getParticipantId","dispose","addCommandListener","e","handleMessage","attributes","id","data","message","socket","Socket","this","subscribe","sendSignals","on","CONFERENCE_JOINED","async","createLocalTracks","devices","forEach","replaceTrack","addTrack","monitorVolume","stream","register","document","body","closeConnections","join","handleClick","CONNECTION_DISCONNECTED","window","close","connect","addListeners","startConnection","selector","content","querySelector","response","Ajax","call","args","fail","Notification","exception","methodname","motions","replaceNodeContents","javascript","updateMedia","controls","sharevideo","getLocalTracks","debug","publish","notify","handle","Number","plugin","myUserId","session","status","button","target","closest","stopPropagation","preventDefault","dataset","action","audioTrack","constraints","aspectRatio","exact","height","ideal","width","querySelectorAll","classList","add","remove","videoTrack","mute","state","enabled","processSignal","throttled","navigator","onLine","time","Date","now","lastUpdate","setTimeout","lastsignal","messages","done","subscribeTo","feed","settings","peer","clearInterval","meterId","stop","venue","Event","bubbles","dispatchEvent","getAttribute","peers","includes","username","peerAudioPlayer","sendMessage","text","sendCommandOnce","value","children","usernode","Promise","resolve","node","createElement","setAttribute","image","Fragment","loadFragment","appendChild","innerHTML","then","audio","attach","catch","removeEventListener","handleMuteButtons","bind","handleRaiseHand","onbeforeunload","option","type","event","beforeunload","source","video","currentFeed"],"mappings":"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"}