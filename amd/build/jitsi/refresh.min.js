define("block_deft/jitsi/refresh",["exports","core/fragment","block_deft/jitsi/lib-jitsi-meet.min","core/log","block_deft/jitsi/socket","core/templates"],(function(_exports,_fragment,_libJitsiMeet,_log,_socket,_templates){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/*
   * Refresh content when changed on the system
   *
   * @package    block_deft
   * @module     block_deft/jitis/refresh
   * @copyright  2022 Daniel Thies <dethies@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */var domain;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_fragment=_interopRequireDefault(_fragment),_libJitsiMeet=_interopRequireDefault(_libJitsiMeet),_log=_interopRequireDefault(_log),_socket=_interopRequireDefault(_socket),_templates=_interopRequireDefault(_templates);return _exports.default=class{constructor(contextid,selector,jwt,throttle,server,room){this.contextid=contextid,this.selector=selector,this.throttle=throttle,this.throttled=!1,this.lastupdate=0,this.server=server,domain=server,_libJitsiMeet.default.init(),_libJitsiMeet.default.setLogLevel(_libJitsiMeet.default.logLevels.DEBUG),this.connection=new _libJitsiMeet.default.JitsiConnection(null,jwt,{serviceUrl:"https://".concat(domain,"/http-bind"),hosts:{domain:domain,muc:"conference.".concat(domain)}}),this.connection.addEventListener(_libJitsiMeet.default.events.connection.CONNECTION_ESTABLISHED,(()=>{this.room=this.connection.initJitsiConference(room,{disableSimulcast:!0}),this.room.addCommandListener("updateinterface",(e=>{this.handleMessage(e.attributes.id,{data:e.attributes.message})})),this.socket=new _socket.default(this.room),this.socket.subscribe((()=>{this.update()})),document.body.addEventListener("deftaction",(()=>{this.socket.notify()})),this.room.join()})),this.connection.connect()}update(){if(document.querySelector(this.selector)){let content=document.querySelector(this.selector).parentNode,component=content.closest("[data-component]")&&content.closest("[data-component]").getAttribute("data-component")||"block_deft",data={};if(!content)return;if(this.lastupdate+this.throttle>Date.now()||document.activeElement.closest(this.selector)&&document.activeElement.closest("select"))return void((!this.throttled||this.lastupdate+this.throttle<Date.now())&&(setTimeout((()=>{this.update()}),Math.max(this.lastupdate+this.throttle-Date.now(),40)),this.throttled=!0));document.querySelector(this.selector).querySelectorAll('[data-type="comments"] .block_deft_comments.expanded').forEach((opencomments=>{data.opencomments=data.opencomments||[],data.opencomments.push(opencomments.closest("[data-task]").getAttribute("data-task"))})),document.querySelector(this.selector).closest("[data-modified]")&&(data.lastmodified=document.querySelector(this.selector).closest("[data-modified]").getAttribute("data-modified")),_fragment.default.loadFragment(component,"content",this.contextid,{jsondata:JSON.stringify(data)}).done(((html,js)=>{html&&this.replace(content,html,js)})).catch(_log.default.debug),this.throttled=!1,this.lastupdate=Date.now()}}replace(content,html,js){let setScroll=()=>!0,setHeight=()=>!0;content.style.height=content.offsetHeight,setTimeout((()=>{content.style.height=null})),content.querySelectorAll(".block_deft_comments").forEach((comments=>{const position=comments.scrollTop,task=comments.closest("[data-task]").getAttribute("data-task"),recurse=setScroll;setScroll=()=>{content.querySelectorAll('[data-task="'+task+'"]').forEach((task=>{task.querySelector(".block_deft_comments").scrollTop=position})),recurse()}})),content.querySelectorAll("[data-summary]").forEach((summary=>{const height=summary.offsetHeight,task=summary.getAttribute("data-summary"),recurse=setHeight;setHeight=()=>{content.querySelectorAll('[data-summary="'+task+'"]').forEach((summary=>{summary.setAttribute("style","min-height: "+height+"px;")})),recurse()}})),_templates.default.replaceNodeContents(content,html,js),setScroll(),setHeight()}},_exports.default}));

//# sourceMappingURL=refresh.min.js.map