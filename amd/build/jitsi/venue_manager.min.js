define("block_deft/jitsi/venue_manager",["exports","core/ajax","core/fragment","block_deft/jitsi/lib-jitsi-meet.min","core/log","core/notification","block_deft/jitsi/socket","block_deft/venue_manager"],(function(_exports,_ajax,_fragment,_libJitsiMeet,_log,_notification,_socket,_venue_manager){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/*
   * Deft response Jitsi integration venue manager
   *
   * @package    block_deft
   * @module     block_deft/jitsi/venue_manager
   * @copyright  2025 Daniel Thies
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */var domain,connection;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,_ajax=_interopRequireDefault(_ajax),_fragment=_interopRequireDefault(_fragment),_libJitsiMeet=_interopRequireDefault(_libJitsiMeet),_log=_interopRequireDefault(_log),_notification=_interopRequireDefault(_notification),_socket=_interopRequireDefault(_socket),_venue_manager=_interopRequireDefault(_venue_manager);class MediaManager extends _venue_manager.default{constructor(contextid,server,room,userinfo,jwt,peerid){super(contextid,"",[],"",!0,!0,14400,0,""),this.contextid=contextid,domain=server,this.userinfo=[],this.peerid=peerid,this.displayedTracks=[],this.videoTracks={},this.audioTracks={},_libJitsiMeet.default.init(),_libJitsiMeet.default.setLogLevel(_libJitsiMeet.default.logLevels.DEBUG),connection&&connection.disconnect(),(connection=new _libJitsiMeet.default.JitsiConnection(null,jwt,{serviceUrl:"https://".concat(domain,"/http-bind"),hosts:{domain:domain,muc:"conference.".concat(domain)}})).addEventListener(_libJitsiMeet.default.events.connection.CONNECTION_ESTABLISHED,(()=>{this.room=connection.initJitsiConference(room,{disableSimulcast:!0}),this.room.addEventListener(_libJitsiMeet.default.events.conference.TRACK_ADDED,(track=>{this.onRemoteTrack(track)})),this.room.addEventListener(_libJitsiMeet.default.events.conference.TRACK_REMOVED,(track=>{"video"==track.getType()?this.videoTracks[track.getParticipantId()]=null:this.audioTracks[track.getParticipantId()]=null,track.dispose()})),this.room.addCommandListener("updateinterface",(e=>{this.handleMessage(e.attributes.id,{data:e.attributes.message})})),this.socket=new _socket.default(this.room),this.socket.subscribe((()=>{this.sendSignals()})),this.room.on(_libJitsiMeet.default.events.conference.CONFERENCE_JOINED,(async()=>{(await _libJitsiMeet.default.createLocalTracks({devices:["audio"]})).forEach((track=>{this["".concat(track.getType(),"Track")]?this.room.replaceTrack(this["".concat(track.getType(),"Track")],track):this.room.addTrack(track),this["".concat(track.getType(),"Track")]=track,this.monitorVolume(track.stream)})),this.register()})),document.body.addEventListener("venueclosed",(()=>{this.closeConnections()})),this.room.join(),document.body.addEventListener("click",(e=>this.handleClick(e)))})),connection.addEventListener(_libJitsiMeet.default.events.connection.CONNECTION_DISCONNECTED,(()=>{window.close()})),connection.connect(),this.addListeners()}startConnection(){}onRemoteTrack(track){_log.default.debug(track),"video"==track.getType()?this.videoTracks[track.getParticipantId()]=track:this.audioTracks[track.getParticipantId()]=track,document.body.dispatchEvent(new CustomEvent("deftaction",{}))}async publish(publish){await _ajax.default.call([{args:{id:this.peerid,publish:publish,room:0},contextid:this.contextid,fail:_notification.default.exception,methodname:"block_deft_publish_feed"}])[0],document.body.dispatchEvent(new CustomEvent("deftaction",{})),this.socket.notify()}async register(){const response=await _ajax.default.call([{args:{handle:0,id:Number(this.peerid),plugin:this.room.myUserId(),room:0,session:0},contextid:this.contextid,fail:_notification.default.exception,methodname:"block_deft_join_room"}])[0];return response.status,document.body.dispatchEvent(new CustomEvent("deftaction",{})),this.socket.notify(),response}async handleClick(e){const button=e.target.closest('a[data-action="publish"], a[data-action="unpublish"]');if(button)if(e.stopPropagation(),e.preventDefault(),"publish"==button.dataset.action){if(!this.audioTrack)return;(await _libJitsiMeet.default.createLocalTracks({devices:["video"],constraints:{aspectRatio:{exact:1},height:{ideal:360},width:{ideal:360}}})).forEach((track=>{this["".concat(track.getType(),"Track")]?this.room.replaceTrack(this["".concat(track.getType(),"Track")],track):this.room.addTrack(track),this["".concat(track.getType(),"Track")]=track})),this.publish(!0),document.querySelectorAll('a[data-action="publish"]').forEach((button=>{button.classList.add("hidden")})),document.querySelectorAll('a[data-action="unpublish"]').forEach((button=>{button.classList.remove("hidden")}))}else document.querySelectorAll('a[data-action="publish"]').forEach((button=>{button.classList.remove("hidden")})),document.querySelectorAll('a[data-action="unpublish"]').forEach((button=>{button.classList.add("hidden")})),this.videoTrack&&(this.videoTrack.dispose(),this.videoTrack=null),this.publish(!1)}mute(state){this.audioTrack&&(this.audioTrack.track.enabled=!state)}processSignal(){}sendSignals(){if(this.throttled||!navigator.onLine)return;const time=Date.now();if(this.lastUpdate+200>time)return this.throttled=!0,setTimeout((()=>{this.throttled=!1}),this.lastUpdate+250-time),void this.sendSignals();this.lastUpdate=time,_ajax.default.call([{args:{contextid:this.contextid,lastsignal:0,messages:[]},contextid:this.contextid,done:response=>{this.subscribeTo(response.feed),response.settings.forEach((peer=>{if(peer.id==Number(this.peerid)){if(peer.status)return clearInterval(this.meterId),this.audioTrack&&this.audioTrack.track.stop(),document.querySelectorAll('[data-region="deft-venue"] [data-peerid="'+this.peerid+'"], [data-region="deft-venue"] [data-action="publish"]').forEach((venue=>{const e=new Event("venueclosed",{bubbles:!0});venue.dispatchEvent(e)})),this.socket.disconnect(),void this.closeConnections();this.mute(peer.mute)}document.querySelectorAll('[data-peerid="'+peer.id+'"] [data-action="mute"], [data-peerid="'+peer.id+'"] [data-action="unmute"]').forEach((button=>{peer.mute==("mute"==button.getAttribute("data-action"))?button.classList.add("hidden"):button.classList.remove("hidden")})),!response.peers.includes(Number(peer.id))&&document.querySelector('#deft_audio [data-peerid="'+peer.id+'"]')&&document.querySelector('#deft_audio [data-peerid="'+peer.id+'"]').remove(),!document.querySelector('#deft_audio [data-peerid="'+peer.id+'"]')&&this.audioTracks[peer.username]&&peer.id!=this.peerid&&this.peerAudioPlayer(peer)})),response.peers.includes(Number(this.peerid))&&response.peers.includes(Number(response.feed))},fail:_notification.default.exception,methodname:"block_deft_send_signal"}])}sendMessage(text){text&&this.room.sendCommandOnce("updateinterface",{value:"updateinterface",attributes:{id:this.peerid,message:text},children:[]})}peerAudioPlayer(peer){const usernode=document.querySelector('#deft_audio div[data-peerid="'+peer.id+'"] audio');if(usernode)return Promise.resolve(usernode);{const node=document.createElement("div");return node.setAttribute("data-peerid",peer.id),document.querySelector("body#page-blocks-deft-venue")?node.setAttribute("class","col col-12 col-sm-6 col-md-4 col-lg-3 p-2"):node.setAttribute("class","col col-12 col-sm-6 col-md-4 p-2"),window.setTimeout((()=>{node.querySelectorAll("img.card-img-top").forEach((image=>{image.setAttribute("height",null),image.setAttribute("width",null)}))})),_fragment.default.loadFragment("block_deft","venue",this.contextid,{peerid:peer.id}).done((userinfo=>{document.querySelector('#deft_audio div[data-peerid="'+peer.id+'"] audio')||(document.querySelector("#deft_audio").appendChild(node),node.innerHTML=userinfo)})).then((()=>{const audio=document.querySelector('#deft_audio div[data-peerid="'+peer.id+'"] audio');if(audio){this.audioTracks[peer.username].attach(audio)}return audio})).catch(_notification.default.exception)}}addListeners(){document.querySelector("body").removeEventListener("click",this.handleMuteButtons.bind(this)),document.querySelector("body").addEventListener("click",this.handleMuteButtons.bind(this)),document.querySelector("body").removeEventListener("click",this.handleRaiseHand.bind(this)),document.querySelector("body").addEventListener("click",this.handleRaiseHand.bind(this)),document.querySelector("body").removeEventListener("click",this.closeConnections.bind(this)),document.querySelector("body").addEventListener("click",this.closeConnections.bind(this)),window.onbeforeunload=this.closeConnections.bind(this)}async handleMuteButtons(e){const button=e.target.closest('a[data-action="mute"], a[data-action="unmute"]');if(button){const action=button.getAttribute("data-action"),peerid=button.closest("[data-peerid]").getAttribute("data-peerid");e.stopPropagation(),e.preventDefault(),peerid==this.peerid&&this.mute("mute"==action),await _ajax.default.call([{args:{mute:"mute"==action,peerid:peerid,status:!1},fail:_notification.default.exception,methodname:"block_deft_venue_settings"}]),button.closest("[data-peerid]").querySelectorAll('[data-action="mute"], [data-action="unmute"]').forEach((option=>{option.getAttribute("data-action")==action?option.classList.add("hidden"):option.classList.remove("hidden")})),this.socket.notify(),document.body.dispatchEvent(new CustomEvent("deftaction",{}))}}closeConnections(e){if(e&&"click"==e.type){if(!e.target.closest('[data-region="deft-venue"] a[data-action="close"]'))return;e.stopPropagation(),e.preventDefault()}document.querySelectorAll('[data-region="deft-venue"] a[data-action="close"] i').forEach((button=>{button.classList.add("bg-danger")})),this.room&&this.room.getLocalTracks().forEach((track=>{track.dispose()})),document.querySelector("body").classList.remove("block_deft_raisehand"),_ajax.default.call([{args:{mute:!1,status:!0},fail:_notification.default.exception,methodname:"block_deft_venue_settings"}]),document.body.dispatchEvent(new CustomEvent("deftaction",{})),clearInterval(this.meterId),connection.disconnect(),document.querySelectorAll('[data-region="deft-venue"] [data-peerid="'+this.peerid+'"]').forEach((venue=>{const event=new Event("venueclosed");venue.dispatchEvent(event)})),window.beforeunload=null,this.sendSignals()}subscribeTo(source){if(_log.default.debug(source),!source||!this.videoTracks[source])return document.querySelectorAll('[data-region="deft-venue"] video').forEach((video=>{video.classList.add("hidden")})),_log.default.debug("no source"),void(this.currentFeed=null);if(this.currentFeed==source)return void _log.default.debug("no change");_log.default.debug(this.currentFeed),this.currentFeed=source;const track=this.videoTracks[source];document.querySelectorAll('[data-region="deft-venue"] video').forEach((video=>{track.attach(video),video.classList.remove("hidden")}))}}return _exports.default=MediaManager,_exports.default}));

//# sourceMappingURL=venue_manager.min.js.map