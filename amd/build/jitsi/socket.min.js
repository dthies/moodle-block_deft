define("block_deft/jitsi/socket",["exports","core/ajax","core/log","core/notification"],(function(_exports,_ajax,_log,_notification){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/*
   * Open and maintain a WebSocket to recieve messages from server.
   *
   * @package    block_deft
   * @module     block_deft/socket
   * @copyright  2022 Daniel Thies <dethies@gmail.com>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=_exports.Socket=void 0,_ajax=_interopRequireDefault(_ajax),_log=_interopRequireDefault(_log),_notification=_interopRequireDefault(_notification);class Socket{constructor(room){this.room=room,this.listeners=[]}connect(contextid,token){return this.websocket=new WebSocket("wss://deftly.us/ws"),this.websocket.onopen=e=>{this.websocket.send(token),this.listeners.forEach((callback=>{this.websocket.addCommandListener("message",callback),callback.apply(this,[e])}))},this.websocket.addEventListener("close",(e=>(_log.default.debug("Disconnected"),this.disconnected?this:(1011==e.code?(_log.default.debug("Authentication failed"),this.renewToken(contextid)):setTimeout((()=>{_log.default.debug("Reconnecting"),this.connect(contextid,token)}),5e3),!0)))),this}disconnect(){return this.disconnected=!0,this}notify(){this.room.sendCommandOnce("message",{})}subscribe(callback){return this.room.addCommandListener("message",callback),this.listeners.push(callback),this}renewToken(contextid){_ajax.default.call([{methodname:"block_deft_renew_token",args:{contextid:contextid},done:replacement=>{_log.default.debug("Reconnecting"),this.connect(contextid,replacement.token)},fail:_notification.default.exception}])}}_exports.Socket=Socket;var _default=Socket;return _exports.default=_default,_exports.default}));

//# sourceMappingURL=socket.min.js.map